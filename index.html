<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhysiatiÄ‡ | Advanced Physics</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2980b9">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- 1. Variables & Base --- */
        :root { 
            --primary: #2d3436; --accent: #2980b9; --bg-body: #ffffff; --bg-card: #ffffff;
            --text-main: #2d3436; --text-sec: #636e72; --nav-bg: rgba(255, 255, 255, 0.95);
            --img-fit: contain; --radius: 16px; --glow: 0 0 10px rgba(41, 128, 185, 0.3);
        }
        body.dark-mode {
            --primary: #dfe6e9; --bg-body: #1e272e; --bg-card: #2d3436; --text-main: #f1f2f6;
            --text-sec: #b2bec3; --nav-bg: rgba(30, 39, 46, 0.95); --glow: 0 0 15px rgba(255, 255, 255, 0.2);
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; transition: background 0.3s, color 0.3s; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg-body); color: var(--text-main); overflow-x: hidden; }

        /* --- 2. Animations --- */
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* Intro Animation */
        #intro-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: #000; z-index: 99999; display: flex; justify-content: center; align-items: center; pointer-events: none; opacity: 0; transition: opacity 0.5s; }
        #intro-overlay.active { opacity: 1; pointer-events: auto; }
        .bolt { position: absolute; top: 50%; width: 50%; height: 10px; transform: translateY(-50%); z-index: 2; }
        .bolt-left { left: -50%; background: linear-gradient(90deg, transparent, #00f2ff); box-shadow: 0 0 20px #00f2ff; clip-path: polygon(0 40%, 100% 40%, 100% 60%, 0 60%); }
        .bolt-right { right: -50%; background: linear-gradient(-90deg, transparent, #ff0055); box-shadow: 0 0 20px #ff0055; clip-path: polygon(0 40%, 100% 40%, 100% 60%, 0 60%); }
        .active .bolt-left { animation: strikeLeft 1s cubic-bezier(0.7, 0, 0.3, 1) forwards; }
        .active .bolt-right { animation: strikeRight 1s cubic-bezier(0.7, 0, 0.3, 1) forwards; }
        .collision-flash { position: absolute; width: 20px; height: 20px; background: white; border-radius: 50%; opacity: 0; box-shadow: 0 0 50px 20px white, 0 0 100px 50px #00f2ff, 0 0 100px 50px #ff0055; }
        .active .collision-flash { animation: explode 0.5s ease-out 0.9s forwards; }
        .intro-text { font-size: 3rem; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 2px; opacity: 0; z-index: 5; text-shadow: 0 0 10px white, 0 0 20px var(--accent); text-align: center; }
        .intro-text span { color: #00f2ff; display: block; font-size: 1.5rem; margin-top: 10px;}
        .active .intro-text { animation: textGlitch 2.5s ease-out 1s forwards; }
        @keyframes strikeLeft { 0% { left: -60%; } 100% { left: 0%; } } @keyframes strikeRight { 0% { right: -60%; } 100% { right: 0%; } }
        @keyframes explode { 0% { transform: scale(0); opacity: 1; } 50% { transform: scale(20); opacity: 0.8; } 100% { transform: scale(50); opacity: 0; } }
        @keyframes textGlitch { 0% { opacity: 0; transform: scale(0.8); } 10% { opacity: 1; transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }

        /* --- 3. UI Components --- */
        nav { display: flex; justify-content: space-between; align-items: center; padding: 15px 5%; background: var(--nav-bg); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .logo { font-size: 1.4rem; font-weight: 800; color: var(--text-main); cursor: pointer; display: flex; align-items: center; gap: 8px; }
        
        .nav-center { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 0px; max-width: 60%; }
        .nav-center::-webkit-scrollbar { height: 0; width: 0; }
        
        .nav-link { text-decoration: none; color: var(--text-sec); font-weight: 500; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; white-space: nowrap; transition: 0.3s; }
        .nav-link:hover, .nav-link.active-page { background: var(--accent); color: white; transform: translateY(-2px); }
        
        .nav-actions { display: flex; align-items: center; gap: 10px; }
        .physics-toggle { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid var(--accent); color: var(--accent); font-size: 1rem; box-shadow: var(--glow); background: transparent; transition: 0.3s; }
        .login-btn { border: 2px solid var(--accent); color: var(--accent); padding: 5px 15px; border-radius: 50px; font-weight: 600; cursor: pointer; background: transparent; font-size: 0.9rem; }
        .nav-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); cursor: pointer; }

        /* --- Content Layout --- */
        .page-container { padding: 40px 5%; min-height: 80vh; display: none; animation: slideIn 0.5s ease-out; }
        .active-view { display: block; }

        .hero-section { display: flex; align-items: center; justify-content: space-between; margin-bottom: 60px; gap: 30px; }
        .hero-text h1 { font-size: 3rem; line-height: 1.2; margin-bottom: 20px; color: var(--text-main); }
        .hero-img { flex: 1; display: flex; justify-content: center; animation: float 6s ease-in-out infinite; }
        .hero-img img { width: 100%; max-width: 500px; border-radius: var(--radius); filter: drop-shadow(0 20px 40px rgba(0,0,0,0.1)); object-fit: contain; }

        .section-header { text-align: center; margin-bottom: 40px; }
        .section-header h2 { font-size: 2.2rem; color: var(--text-main); display: inline-block; border-bottom: 3px solid var(--accent); padding-bottom: 5px; }

        /* Grid System */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        
        .card { background: var(--bg-card); border-radius: var(--radius); overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.05); transition: 0.4s; position: relative; animation: popIn 0.5s ease-out; border: 1px solid rgba(0,0,0,0.05); }
        .card:hover { transform: translateY(-10px); border-color: var(--accent); }
        .card img { width: 100%; height: 220px; object-fit: var(--img-fit); background: #f8f9fa; padding: 10px; }
        .card-body { padding: 20px; }
        .card-delete-btn { position: absolute; top: 10px; right: 10px; background: #e74c3c; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: none; z-index: 10; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .editing .card-delete-btn { display: flex; }

        /* Placeholder for Empty Tabs */
        .empty-placeholder { text-align: center; padding: 50px; color: var(--text-sec); border: 2px dashed #ddd; border-radius: 20px; margin-top: 20px; }

        /* --- Footer --- */
        footer { padding: 40px 5%; text-align: center; margin-top: 50px; background: #1e272e; color: white; }
        .footer-socials { display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; font-size: 1.5rem; }
        .footer-socials a { color: white; transition: 0.3s; }
        .footer-socials a:hover { color: var(--accent); transform: scale(1.2); }

        /* --- Admin Panel --- */
        #admin-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; display: none; justify-content: center; align-items: center; padding: 10px; backdrop-filter: blur(5px); }
        .dash-board { background: var(--bg-card); width: 100%; max-width: 1100px; height: 90vh; border-radius: 20px; display: flex; overflow: hidden; color: var(--text-main); position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        
        .close-dash-x { position: absolute; top: 15px; right: 20px; font-size: 1.8rem; color: var(--text-sec); cursor: pointer; z-index: 20; transition: 0.3s; background: var(--bg-card); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .close-dash-x:hover { color: #e74c3c; background: #eee; transform: rotate(90deg); }

        .sidebar { width: 260px; background: #2d3436; color: white; padding: 25px; display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; }
        .sidebar h3 { margin-bottom: 20px; font-size: 1.2rem; opacity: 0.8; }
        .sb-btn { padding: 12px 15px; cursor: pointer; border-radius: 8px; display: flex; align-items: center; gap: 10px; opacity: 0.7; transition: 0.3s; font-size: 0.95rem; }
        .sb-btn:hover, .sb-btn.active { background: var(--accent); opacity: 1; transform: translateX(5px); }
        
        .dash-main { flex: 1; padding: 40px; overflow-y: auto; background: var(--bg-body); position: relative; }
        .dash-section { display: none; animation: slideIn 0.3s; }
        .dash-section.active-sec { display: block; }
        
        .setting-row { margin-bottom: 15px; background: rgba(128,128,128,0.05); padding: 15px; border-radius: 10px; border: 1px solid rgba(0,0,0,0.05); }
        .setting-row label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem; }
        .setting-row input, .setting-row select { padding: 10px; border-radius: 6px; border: 1px solid #ddd; width: 100%; margin-top: 5px; background: var(--bg-card); color: var(--text-main); }

        .team-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .team-table td { padding: 12px 5px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .admin-pic-small { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }
        .nav-item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0,0,0,0.02); margin-bottom: 5px; border-radius: 5px; }

        .editable { border: 2px dashed #ff7675; cursor: pointer; position: relative; }
        .editable-img { border: 4px solid #ff7675; cursor: pointer; position: relative; }
        .editable-img::after { content: 'ðŸ“¸ Click'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 5px; border-radius: 5px; font-size: 0.8rem; pointer-events: none; }
        
        #saveBtn { position: fixed; bottom: 30px; right: 30px; background: #00b894; color: white; padding: 12px 35px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; display: none; z-index: 6000; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }

        @media (max-width: 900px) {
            .hero { flex-direction: column; text-align: center; padding-top: 30px; }
            .hero-text { order: 1; } .hero-img { order: 2; width: 100%; }
            .hero h1 { font-size: 2.2rem; }
            .dash-board { flex-direction: column; height: 100vh; width: 100%; border-radius: 0; }
            .sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding: 15px; align-items: center; }
            .sidebar h3 { display: none; }
            .sb-btn { white-space: nowrap; font-size: 0.8rem; padding: 8px 12px; }
            .dash-main { padding: 20px; padding-top: 50px; }
            .close-dash-x { top: 10px; right: 10px; background: #eee; }
        }
    </style>
</head>
<body>

    <div id="intro-overlay">
        <div class="bolt bolt-left"></div> <div class="bolt bolt-right"></div> <div class="collision-flash"></div>
        <div class="intro-text" id="introMsg">Welcome <br> <span>Engineer</span></div>
    </div>

    <input type="file" id="imgUploadInput" accept="image/*" style="display: none;">

    <nav>
        <div class="logo" onclick="route('home')"><i class="fas fa-atom"></i> <span data-db="site_name">PhysiatiÄ‡</span></div>
        <div class="nav-center" id="dynamicNav"></div>
        <div class="nav-actions">
            <button class="physics-toggle" onclick="toggleTheme()" id="themeBtn"><i id="themeIcon" class="fas fa-lightbulb"></i></button>
            <div id="loggedOutUI"><button class="login-btn" onclick="openLogin()">Login</button></div>
            <div id="loggedInUI" class="user-badge" style="display:none;">
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" id="myNavAvatar" class="nav-avatar" onclick="openDashboard()">
            </div>
        </div>
    </nav>

    <div id="main-container">
        <div id="page-content-area" class="page-container active-view">
            <div class="hero-section">
                <div class="hero-text">
                    <h1 data-db="home_title">Discover the <br><strong>Future of Physics</strong></h1>
                    <p data-db="home_desc" style="color:var(--text-sec); font-size:1.1rem;">The ultimate platform for engineering students.</p>
                </div>
                <div class="hero-img"><img data-img="home_hero" src="hero-main.jpg"></div>
            </div>
            <div class="section-header"><h2 data-db="home_proj_title">Our Projects</h2></div>
            <div class="grid" id="grid-home">
                <div class="card">
                    <button class="card-delete-btn" onclick="deleteCard(this)"><i class="fas fa-trash"></i></button>
                    <img data-img="p1_img" src="https://m.media-amazon.com/images/I/71J1k7-w-LL.jpg">
                    <div class="card-body"><h3 data-db="p1_t">Line Follower</h3><p data-db="p1_d">Autonomous robot tracking pathways.</p></div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div style="display:flex; flex-direction:column; align-items:center; gap:15px;">
            <h3 data-db="foot_title">PhysiatiÄ‡ Hub</h3>
            <div class="footer-socials">
                <a id="linkSocial1" href="#" target="_blank"><i id="iconSocial1" class="fab fa-facebook"></i></a>
                <a id="linkSocial2" href="#" target="_blank"><i id="iconSocial2" class="fab fa-whatsapp"></i></a>
                <a id="linkSocial3" href="#"><i id="iconSocial3" class="fas fa-phone"></i></a>
            </div>
            <div style="border-top:1px solid #444; width:100%; padding-top:10px; opacity:0.7; font-size:0.9rem;">Developed by <span data-db="dev_name" style="color:var(--accent); font-weight:bold;">Eng. Adham Sayed</span></div>
        </div>
    </footer>

    <div id="login-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
        <div style="background:var(--bg-card); padding:40px; border-radius:16px; width:350px; text-align:center; position:relative;">
            <i class="fas fa-times" onclick="document.getElementById('login-modal').style.display='none'" style="position:absolute; top:15px; right:15px; cursor:pointer;"></i>
            <h2 style="margin-bottom:20px;">Admin Access</h2>
            <input type="text" id="u" placeholder="Username" style="width:100%; padding:10px; margin:10px 0; border:1px solid #ddd; border-radius:5px;">
            <input type="password" id="p" placeholder="Password" style="width:100%; padding:10px; margin:10px 0; border:1px solid #ddd; border-radius:5px;">
            <button onclick="login()" style="width:100%; padding:10px; background:var(--accent); color:white; border:none; border-radius:5px; cursor:pointer;">Login</button>
        </div>
    </div>

    <div id="admin-panel">
        <div class="dash-board">
            <div class="close-dash-x" onclick="closeDashboard()"><i class="fas fa-times"></i></div>

            <div class="sidebar">
                <h3>Control Panel</h3>
                <div class="sb-btn active" onclick="switchTab('content')"><i class="fas fa-edit"></i> Page Content</div>
                <div class="sb-btn" onclick="switchTab('menu')"><i class="fas fa-list"></i> Menu Builder</div>
                <div class="sb-btn" onclick="switchTab('socials')"><i class="fas fa-share-alt"></i> Socials & Footer</div>
                <div class="sb-btn" id="styleTabBtn" onclick="switchTab('style')" style="display:none;"><i class="fas fa-font"></i> Style Editor</div>
                <div class="sb-btn" onclick="switchTab('profile')"><i class="fas fa-user-circle"></i> Profile & Security</div>
                <div class="sb-btn" onclick="switchTab('theme')"><i class="fas fa-palette"></i> Theme</div>
                <div class="sb-btn" id="superTab" style="display:none;" onclick="switchTab('team')"><i class="fas fa-users"></i> Team Manager</div>
                
                <div style="margin-top:auto;">
                    <div class="sb-btn" onclick="closeDashboard()" style="background:#636e72; color:white; margin-bottom:5px;"><i class="fas fa-arrow-left"></i> Close Panel</div>
                    <div class="sb-btn" onclick="performLogout()" style="background:#c0392b; color:white;"><i class="fas fa-sign-out-alt"></i> Logout</div>
                </div>
            </div>
            
            <div class="dash-main">
                <div id="tab-content" class="dash-section active-sec">
                    <h2>Edit Current Page: <span id="lblCurrentPage" style="color:var(--accent)">Home</span></h2>
                    <p>Click "Add Project" to add a new card to <b>THIS</b> specific page.</p>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button onclick="enableEdit()" style="padding:10px 20px; background:#27ae60; color:white; border:none; border-radius:5px; cursor:pointer;"><i class="fas fa-pen"></i> Enable Live Edit</button>
                        <button onclick="addNewProject()" style="padding:10px 20px; background:var(--accent); color:white; border:none; border-radius:5px; cursor:pointer;"><i class="fas fa-plus"></i> Add Project Here</button>
                    </div>
                </div>

                <div id="tab-menu" class="dash-section">
                    <h2>Menu Builder</h2>
                    <p>Create new tabs. Each tab gets its own blank page to fill.</p>
                    <div class="setting-row">
                        <input id="newTabName" placeholder="Tab Name (e.g. Gallery)" style="width:70%; display:inline-block;">
                        <button onclick="addTab()" style="width:25%; background:var(--accent); color:white; border:none; padding:10px;">Add</button>
                    </div>
                    <div id="menuList"></div>
                </div>

                <div id="tab-socials" class="dash-section">
                    <h2>Contact & Socials</h2>
                    <div class="setting-row"><label>Icon 1</label><input id="inIcon1" placeholder="fab fa-facebook" style="width:48%;"><input id="inLink1" placeholder="Link..." style="width:48%;"></div>
                    <div class="setting-row"><label>Icon 2</label><input id="inIcon2" placeholder="fab fa-whatsapp" style="width:48%;"><input id="inLink2" placeholder="Link..." style="width:48%;"></div>
                    <div class="setting-row"><label>Icon 3</label><input id="inIcon3" placeholder="fas fa-phone" style="width:48%;"><input id="inLink3" placeholder="Link..." style="width:48%;"></div>
                    <button onclick="saveSocials()" style="padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:5px; width:100%;">Save Social Settings</button>
                </div>

                <div id="tab-style" class="dash-section">
                    <h2>Style Editor</h2><p>Editing: <b id="editingElementName" style="color:var(--accent);">None</b></p>
                    <div class="setting-row"><label>Text</label><input type="text" id="styleTextVal" oninput="applyLiveStyle('text')"></div>
                    <div class="setting-row"><label>Color</label><input type="color" id="styleColorVal" oninput="applyLiveStyle('color')"></div>
                    <div class="setting-row"><label>Size (px)</label><input type="number" id="styleSizeVal" oninput="applyLiveStyle('size')"></div>
                </div>

                <div id="tab-profile" class="dash-section">
                    <h2>My Profile</h2>
                    <div class="setting-row"><label>Photo</label><img id="previewPic" src="" class="admin-pic-small" style="width:80px; height:80px; cursor:pointer; border:2px dashed var(--accent);" onclick="triggerProfileUpload()"></div>
                    <h3 style="margin-top:20px; border-top:1px solid #ddd; padding-top:10px;">Security</h3>
                    <div class="setting-row"><label>Change Password</label><input type="password" id="oldPass" placeholder="Current Password"><input type="password" id="newPass" placeholder="New Password"><button onclick="changeMyPassword()" style="margin-top:10px; padding:8px 15px; background:var(--primary); color:white; border:none; border-radius:5px; cursor:pointer;">Update Password</button></div>
                </div>

                <div id="tab-theme" class="dash-section">
                    <h2>Design</h2>
                    <div class="setting-row"><label>Main Color</label><input type="color" id="accentColorPicker" value="#2980b9"></div>
                    <div class="setting-row"><label>Image Fit</label><select id="imgFitSelect"><option value="contain">Contain (Full Image)</option><option value="cover">Cover (Fill Box)</option></select></div>
                    <div class="setting-row"><label>Light Icon</label><input type="text" id="iconLightInput"></div><div class="setting-row"><label>Dark Icon</label><input type="text" id="iconDarkInput"></div>
                    <button onclick="saveThemeSettings()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer;">Save Theme</button>
                </div>

                <div id="tab-team" class="dash-section">
                    <h2>Team Manager</h2>
                    <div class="setting-row"><input id="newAdmin" placeholder="User" style="width:30%;"><input id="newPass" placeholder="Pass" style="width:30%;"><button onclick="addAdmin()" style="width:30%; background:var(--accent); color:white; border:none; padding:10px;">Add</button></div>
                    <table class="team-table"><thead><tr><th>Img</th><th>User</th><th>Pass</th><th>Action</th></tr></thead><tbody id="teamList"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <button id="saveBtn" onclick="savePageContent()">Save This Page</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAXV0GFrmWdO26Zz8cP5Ko_Kn-9wedeT9o",
          authDomain: "physiatic-508a1.firebaseapp.com",
          projectId: "physiatic-508a1",
          storageBucket: "physiatic-508a1.firebasestorage.app",
          messagingSenderId: "729031647428",
          appId: "1:729031647428:web:11bbf71bff5daedc1aa991"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let currentUser = JSON.parse(localStorage.getItem('user'));
        let activeTab = 'home';
        let navTabs = [{id: 'home', label: 'Home'}];
        let targetImgElement = null; let selectedElement = null; let isProfileUpload = false;
        window.iconLight = 'fas fa-lightbulb'; window.iconDark = 'fas fa-atom';

        // --- INIT ---
        async function loadConfig() {
            if(!sessionStorage.getItem('introPlayed')) { playAnimation('Welcome', 'Engineer'); sessionStorage.setItem('introPlayed', 'true'); }
            
            const docSnap = await getDoc(doc(db, "settings", "config"));
            if(docSnap.exists()) {
                const data = docSnap.data();
                if(data.accent) document.documentElement.style.setProperty('--accent', data.accent);
                if(data.imgFit) document.documentElement.style.setProperty('--img-fit', data.imgFit);
                
                // UI Inits
                document.getElementById('accentColorPicker').value = data.accent || '#2980b9';
                document.getElementById('imgFitSelect').value = data.imgFit || 'contain';
                if(data.iconLight) window.iconLight = data.iconLight; if(data.iconDark) window.iconDark = data.iconDark;
                document.getElementById('iconLightInput').value = window.iconLight; document.getElementById('iconDarkInput').value = window.iconDark;
                
                if(data.socials) {
                    ['1','2','3'].forEach(i => {
                        if(data.socials['icon'+i]) { document.getElementById('iconSocial'+i).className = data.socials['icon'+i]; document.getElementById('inIcon'+i).value = data.socials['icon'+i]; }
                        if(data.socials['link'+i]) { document.getElementById('linkSocial'+i).href = data.socials['link'+i]; document.getElementById('inLink'+i).value = data.socials['link'+i]; }
                    });
                }

                if(data.navTabs) navTabs = data.navTabs;
                renderNav(); renderMenuBuilder(); updateIconDisplay();
                
                // Load Current Tab Content
                loadTabContent(activeTab);
            } else { renderNav(); }
        }
        loadConfig();

        // --- NAVIGATION & PAGE SYSTEM ---
        function renderNav() {
            const navContainer = document.getElementById('dynamicNav');
            navContainer.innerHTML = navTabs.map(tab => 
                `<a onclick="route('${tab.id}', '${tab.label}')" class="nav-link ${tab.id === 'home' ? 'active-page' : ''}" id="link-${tab.id}">${tab.label}</a>`
            ).join('');
        }

        window.route = function(pageId, label) {
            activeTab = pageId;
            document.getElementById('lblCurrentPage').innerText = label || pageId;
            
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active-page'));
            const link = document.getElementById('link-'+pageId); if(link) link.classList.add('active-page');
            
            loadTabContent(pageId);
        }

        // --- CONTENT LOADER (THE CORE) ---
        async function loadTabContent(tabId) {
            const container = document.getElementById('page-content-area');
            
            if(tabId === 'home') {
                // Ensure default structure exists or load from DB if saved
                const docSnap = await getDoc(doc(db, "site_data", "content_home"));
                if(docSnap.exists() && docSnap.data().html) {
                    container.innerHTML = docSnap.data().html;
                } else {
                    // Keep default HTML currently in DOM if nothing saved
                }
            } else {
                // Load dynamic tab content
                const docSnap = await getDoc(doc(db, "site_data", "content_" + tabId));
                if(docSnap.exists() && docSnap.data().html) {
                    container.innerHTML = docSnap.data().html;
                } else {
                    // Empty State for New Tab
                    container.innerHTML = `
                        <div class="section-header"><h2>${tabId.toUpperCase()}</h2></div>
                        <div class="grid" id="grid-${tabId}">
                            <div class="empty-placeholder">
                                <i class="fas fa-plus-circle" style="font-size:3rem; margin-bottom:10px;"></i>
                                <p>No projects yet. Click 'Add Project' in dashboard.</p>
                            </div>
                        </div>
                    `;
                }
            }
            // Re-apply editable logic if we are in edit mode
            if(document.body.classList.contains('editing')) window.enableEdit();
        }

        // --- ADD PROJECT TO CURRENT TAB ---
        window.addNewProject = function() {
            // Find the grid in the current view
            let grid = document.querySelector('.page-container .grid');
            if(!grid) { alert("Error: No grid found on this page!"); return; }
            
            // Remove empty placeholder if exists
            const placeholder = grid.querySelector('.empty-placeholder');
            if(placeholder) placeholder.remove();

            const id = Date.now();
            const html = `
                <div class="card">
                    <button class="card-delete-btn" onclick="deleteCard(this)"><i class="fas fa-trash"></i></button>
                    <img data-img="img_${id}" src="https://via.placeholder.com/300?text=Upload+Image" class="editable-img">
                    <div class="card-body">
                        <h3 data-db="t_${id}" class="editable">New Project Title</h3>
                        <p data-db="d_${id}" class="editable">Project description...</p>
                    </div>
                </div>`;
            grid.insertAdjacentHTML('beforeend', html);
            window.enableEdit(); // Re-bind
            // Trigger animation for the new card
            const newCard = grid.lastElementChild;
            newCard.style.animation = "popIn 0.5s ease-out";
        }

        window.deleteCard = function(btn) { if(confirm("Delete this card?")) btn.closest('.card').remove(); }

        // --- SAVE CURRENT PAGE ---
        window.savePageContent = async function() {
            const container = document.getElementById('page-content-area');
            const html = container.innerHTML;
            await setDoc(doc(db, "site_data", "content_" + activeTab), { html: html });
            alert(`Page '${activeTab}' Saved Successfully!`);
            location.reload();
        }

        // --- MENU BUILDER ---
        function renderMenuBuilder() {
            const list = document.getElementById('menuList');
            list.innerHTML = navTabs.map(tab => `<div class="nav-item-row"><span>${tab.label}</span>${tab.id !== 'home' ? `<button onclick="removeTab('${tab.id}')" style="color:red; background:none; border:none; cursor:pointer;"><i class="fas fa-trash"></i></button>` : '<span>(Locked)</span>'}</div>`).join('');
        }
        window.addTab = async function() {
            const name = document.getElementById('newTabName').value.trim(); if(!name) return alert("Enter name!");
            const id = name.toLowerCase().replace(/\s+/g, '-'); if(navTabs.find(t => t.id === id)) return alert("Exists!");
            navTabs.push({id: id, label: name}); await updateDoc(doc(db, "settings", "config"), { navTabs: navTabs });
            renderNav(); renderMenuBuilder(); document.getElementById('newTabName').value = ''; alert("Tab Added!");
        }
        window.removeTab = async function(id) {
            if(!confirm("Delete tab?")) return; navTabs = navTabs.filter(t => t.id !== id);
            await updateDoc(doc(db, "settings", "config"), { navTabs: navTabs }); renderNav(); renderMenuBuilder();
        }

        // --- SOCIALS ---
        window.saveSocials = async function() {
            const s = {
                icon1: document.getElementById('inIcon1').value, link1: document.getElementById('inLink1').value,
                icon2: document.getElementById('inIcon2').value, link2: document.getElementById('inLink2').value,
                icon3: document.getElementById('inIcon3').value, link3: document.getElementById('inLink3').value
            };
            await setDoc(doc(db, "settings", "config"), { socials: s }, {merge: true}); alert("Socials Saved!"); location.reload();
        }

        // --- USER MANAGEMENT ---
        window.login = async function() {
            const u = document.getElementById('u').value.trim(); const p = document.getElementById('p').value.trim();
            const docRef = doc(db, "settings", "admins"); const snap = await getDoc(docRef);
            if(!snap.exists()) await setDoc(docRef, { list: [{u:'Adham', p:'20250003', role:'super_admin', img:''}] });
            const list = (await getDoc(docRef)).data().list; const found = list.find(a => a.u === u && a.p === p);
            if(found) { localStorage.setItem('user', JSON.stringify(found)); location.reload(); } else { alert("Wrong Credentials!"); }
        }
        window.performLogout = function() {
            document.getElementById('admin-panel').style.display = 'none'; playAnimation('Goodbye', 'Engineer, Enjoy your day');
            setTimeout(() => { localStorage.removeItem('user'); sessionStorage.removeItem('introPlayed'); location.reload(); }, 3500); 
        }
        window.editUser = async function(oldUser) {
            const newName = prompt("New username for " + oldUser + ":", oldUser); if(!newName || newName === oldUser) return;
            const docRef = doc(db, "settings", "admins"); const snap = await getDoc(docRef); let list = snap.data().list;
            if(list.find(a => a.u === newName)) return alert("Taken!");
            const idx = list.findIndex(a => a.u === oldUser);
            if(idx !== -1) {
                list[idx].u = newName; await setDoc(docRef, { list: list });
                if(currentUser.u === oldUser) { currentUser.u = newName; localStorage.setItem('user', JSON.stringify(currentUser)); }
                alert("Updated!"); loadTeamList();
            }
        }
        window.removeUser = async function(targetUser) {
            if(!confirm("Remove user?")) return; const docRef = doc(db, "settings", "admins"); const snap = await getDoc(docRef);
            let list = snap.data().list.filter(a => a.u !== targetUser); await setDoc(docRef, { list: list }); loadTeamList();
        }
        window.changeMyPassword = async function() {
            const oldP = document.getElementById('oldPass').value; const newP = document.getElementById('newPass').value;
            if(oldP !== currentUser.p) return alert("Incorrect Old Password");
            const docRef = doc(db, "settings", "admins"); const snap = await getDoc(docRef); let list = snap.data().list;
            const idx = list.findIndex(a => a.u === currentUser.u);
            if(idx !== -1) { list[idx].p = newP; await setDoc(docRef, { list: list }); currentUser.p = newP; localStorage.setItem('user', JSON.stringify(currentUser)); alert("Password Changed!"); }
        }
        window.addAdmin = async function() {
            const u = document.getElementById('newAdmin').value; const p = document.getElementById('newPass').value;
            await updateDoc(doc(db, "settings", "admins"), { list: arrayUnion({u, p, role:'admin', img:''}) }); alert("Added!"); loadTeamList();
        }
        async function loadTeamList() {
            const snap = await getDoc(doc(db, "settings", "admins")); const list = snap.data().list || [];
            document.getElementById('teamList').innerHTML = list.map(a => `<tr><td><img src="${a.img || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}" class="admin-pic-small"></td><td><b>${a.u}</b></td><td style="color:#e74c3c;">${a.p}</td><td><button onclick="editUser('${a.u}')" style="background:#f39c12; color:white; border:none; padding:5px; border-radius:4px;"><i class="fas fa-edit"></i></button> ${a.role !== 'super_admin' ? `<button onclick="removeUser('${a.u}')" style="background:#c0392b; color:white; border:none; padding:5px; border-radius:4px;"><i class="fas fa-trash"></i></button>` : ''}</td></tr>`).join('');
        }

        // --- EDITING & UPLOAD ---
        const fileInput = document.getElementById('imgUploadInput');
        window.enableEdit = function() {
            document.getElementById('admin-panel').style.display='none'; document.body.classList.add('editing'); document.getElementById('saveBtn').style.display='block';
            document.querySelectorAll('[data-db], h1, h2, h3, p, span').forEach(el => { 
                if(el.closest('.sidebar') || el.closest('#admin-panel') || el.closest('#intro-overlay')) return;
                if(currentUser.role !== 'super_admin' && (el.closest('footer') || (el.getAttribute('data-db') && el.getAttribute('data-db').includes('dev')))) return;
                el.contentEditable = "true"; el.classList.add('editable');
                el.onclick = (e) => { e.preventDefault(); e.stopPropagation(); openStyleEditor(el); };
            });
            document.querySelectorAll('img').forEach(el => { 
                if(el.closest('.sidebar') || el.closest('#admin-panel')) return;
                el.classList.add('editable-img'); el.onclick = (e) => { e.preventDefault(); targetImgElement = el; isProfileUpload = false; fileInput.click(); };
            });
        }
        window.saveThemeSettings = async function() {
            const color = document.getElementById('accentColorPicker').value; const fit = document.getElementById('imgFitSelect').value;
            const iL = document.getElementById('iconLightInput').value; const iD = document.getElementById('iconDarkInput').value;
            await setDoc(doc(db, "settings", "config"), { accent: color, imgFit: fit, iconLight: iL, iconDark: iD }, {merge: true}); alert("Theme Saved!"); location.reload();
        }
        window.openStyleEditor = function(el) {
            selectedElement = el;
            document.getElementById('admin-panel').style.display='flex'; window.switchTab('style'); document.getElementById('styleTabBtn').style.display='flex';
            document.getElementById('editingElementName').innerText = el.tagName;
            document.getElementById('styleTextVal').value = el.innerText;
        }
        window.applyLiveStyle = function(type) {
            if(!selectedElement) return;
            if(type==='text') selectedElement.innerText = document.getElementById('styleTextVal').value;
            if(type==='color') selectedElement.style.color = document.getElementById('styleColorVal').value;
            if(type==='size') selectedElement.style.fontSize = document.getElementById('styleSizeVal').value + 'px';
        }
        window.triggerProfileUpload = function() { isProfileUpload = true; fileInput.click(); }
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image(); img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas'); const MAX = 600; const scale = MAX / img.width; canvas.width = MAX; canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); const b64 = canvas.toDataURL('image/jpeg', 0.7);
                    if(isProfileUpload) {
                        const docRef = doc(db, "settings", "admins");
                        getDoc(docRef).then(snap => {
                            let list = snap.data().list; const idx = list.findIndex(a => a.u === currentUser.u);
                            if(idx !== -1) { list[idx].img = b64; setDoc(docRef, { list: list }); currentUser.img = b64; localStorage.setItem('user', JSON.stringify(currentUser)); document.getElementById('myNavAvatar').src = b64; document.getElementById('previewPic').src = b64; alert("Updated!"); }
                        });
                    } else if(targetImgElement) targetImgElement.src = b64;
                }
            }
        });

        if(currentUser) {
            document.getElementById('loggedOutUI').style.display='none'; document.getElementById('loggedInUI').style.display='flex';
            if(currentUser.img) { document.getElementById('myNavAvatar').src = currentUser.img; document.getElementById('previewPic').src = currentUser.img; }
            if(currentUser.role === 'super_admin') { document.getElementById('superTab').style.display='flex'; loadTeamList(); }
        }

        function playAnimation(l1, l2) { const ov = document.getElementById('intro-overlay'); document.getElementById('introMsg').innerHTML = `${l1} <br> <span>${l2}</span>`; ov.classList.remove('active'); void ov.offsetWidth; ov.classList.add('active'); setTimeout(() => { ov.classList.remove('active'); }, 3500); }
        window.closeDashboard = function() { document.getElementById('admin-panel').style.display = 'none'; }
    </script>

    <script>
        function updateIconDisplay() { const icon = document.getElementById('themeIcon'); const isDark = document.body.classList.contains('dark-mode'); icon.className = isDark ? window.iconDark : window.iconLight; }
        function toggleTheme() { document.body.classList.toggle('dark-mode'); updateIconDisplay(); localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light'); }
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode'); setTimeout(updateIconDisplay, 1000);
        function openLogin() { document.getElementById('login-modal').style.display='flex'; }
        function openDashboard() { document.getElementById('admin-panel').style.display='flex'; if(!document.body.classList.contains('editing')) { window.switchTab('content'); document.getElementById('styleTabBtn').style.display='none'; } }
        function switchTab(t) { document.querySelectorAll('.dash-section').forEach(s => s.classList.remove('active-sec')); document.getElementById('tab-'+t).classList.add('active-sec'); }
    </script>
</body>
</html>

