<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physiatić | Engineering Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg: #0f172a; --text: #f8fafc; --accent: #3b82f6;
            --glass: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.1);
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        
        #tsparticles { position: fixed; inset: 0; z-index: -1; }

        /* LAYOUT */
        .app-container { display: flex; height: 100vh; position: relative; z-index: 1; transition: 0.3s; }
        
        /* SIDEBAR */
        .sidebar {
            width: 280px; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px);
            border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column;
            transition: transform 0.3s ease; z-index: 50;
        }

        .logo { font-size: 1.8rem; font-weight: 800; text-align: center; margin-bottom: 30px; letter-spacing: 2px; }
        .logo span { color: var(--accent); }

        .nav-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .nav-item {
            padding: 12px 15px; border-radius: 10px; cursor: pointer; color: #94a3b8;
            display: flex; align-items: center; gap: 12px; font-weight: 500; transition: 0.2s;
        }
        .nav-item:hover, .nav-item.active { background: rgba(59, 130, 246, 0.15); color: white; border-left: 3px solid var(--accent); }

        .sidebar-footer { margin-top: auto; padding-top: 15px; border-top: 1px solid var(--border); font-size: 0.8rem; color: #64748b; text-align: center; }

        /* MAIN */
        .main { flex: 1; padding: 20px 40px; display: flex; flex-direction: column; overflow: hidden; position: relative; }

        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; height: 50px; }
        .menu-btn { display: none; font-size: 1.5rem; cursor: pointer; color: var(--text); }
        
        .auth-btn {
            background: rgba(59, 130, 246, 0.1); border: 1px solid var(--accent); color: var(--accent);
            padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 0.9rem;
            display: flex; align-items: center; gap: 8px; transition: 0.3s;
        }
        .auth-btn:hover { background: var(--accent); color: white; box-shadow: 0 0 15px var(--accent); }

        /* TABS */
        .tabs-container { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .tab { 
            padding: 8px 20px; border-radius: 50px; background: rgba(255,255,255,0.02); border: 1px solid var(--border);
            color: #94a3b8; cursor: pointer; white-space: nowrap; font-size: 0.9rem; transition: 0.3s;
        }
        .tab.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* GRID */
        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px; overflow-y: auto; padding-bottom: 100px; padding-right: 5px;
        }
        
        .card {
            background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border); border-radius: 16px;
            padding: 20px; position: relative; display: flex; flex-direction: column;
            animation: fadeIn 0.4s ease-out; backdrop-filter: blur(5px);
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card-icon { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-bottom: 15px; }
        .bg-file { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .bg-vid { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .bg-post { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }

        .btn-action { 
            background: var(--accent); color: white; border: none; padding: 10px; border-radius: 8px;
            width: 100%; margin-top: auto; cursor: pointer; font-weight: 600; text-decoration: none; text-align: center;
        }
        .btn-locked { background: #334155; color: #94a3b8; cursor: not-allowed; }

        /* FAB */
        .fab {
            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px;
            background: var(--accent); border-radius: 50%; display: none;
            align-items: center; justify-content: center; font-size: 24px; color: white;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.5); cursor: pointer; z-index: 100; transition: 0.3s;
        }
        .fab:hover { transform: scale(1.1) rotate(90deg); }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: #1e293b; width: 100%; max-width: 450px; padding: 25px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .inp { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid #334155; border-radius: 8px; color: white; margin-bottom: 15px; }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -100%; height: 100%; width: 260px; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .sidebar.open { transform: translateX(100%); }
            .main { padding: 15px; }
            .menu-btn { display: block; }
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="tsparticles"></div>

    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="logo">PHYSI<span>ATIĆ</span></div>
            <div id="nav-container" class="nav-list"></div>
            <div class="sidebar-footer">
                <div id="admin-panel-btn" class="nav-item" style="display:none; color:#f59e0b; margin-bottom:10px" onclick="openAdminModal()">
                    <i class="fas fa-shield-alt"></i> Super Admin
                </div>
                &copy; Developed by <span>Pimbo</span>
            </div>
        </aside>

        <main class="main">
            <div class="top-bar">
                <div style="display:flex; align-items:center; gap:15px;">
                    <i class="fas fa-bars menu-btn" onclick="toggleSidebar()"></i>
                    <h3 id="page-title" style="margin:0; font-weight:400">Loading...</h3>
                </div>
                <div id="auth-section">
                    <div id="btn-login" class="auth-btn" onclick="openLogin()">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </div>
                    <div id="btn-profile" class="auth-btn" style="display:none; border-color:#10b981; color:#10b981">
                        <i class="fas fa-user-astronaut"></i> <span id="user-role">User</span>
                    </div>
                </div>
            </div>

            <div id="tabs-container" class="tabs-container"></div>
            <div id="content-grid" class="grid"></div>
        </main>

        <div id="fab" class="fab" onclick="openAddModal()"><i class="fas fa-plus"></i></div>
    </div>

    <div id="login-modal" class="modal">
        <div class="modal-box" style="text-align:center">
            <h2 style="margin-top:0">Admin Access</h2>
            <input type="text" id="login-email" class="inp" placeholder="Username">
            <input type="password" id="login-pass" class="inp" placeholder="Password">
            <button onclick="handleLogin()" class="btn-action">Login</button>
            <button onclick="closeModal('login-modal')" class="btn-action" style="background:transparent; color:#64748b; margin-top:10px">Cancel</button>
        </div>
    </div>

    <div id="add-modal" class="modal">
        <div class="modal-box">
            <h3 style="margin-top:0">Add Content</h3>
            <div style="display:flex; gap:10px; margin-bottom:15px">
                <button class="btn-action" id="type-file" onclick="setUploadType('file')" style="background:#334155">PDF/Img</button>
                <button class="btn-action" id="type-video" onclick="setUploadType('video')" style="background:transparent; border:1px solid #334155">Video Link</button>
                <button class="btn-action" id="type-post" onclick="setUploadType('post')" style="background:transparent; border:1px solid #334155">Post</button>
            </div>

            <input type="text" id="upload-title" class="inp" placeholder="Title">
            
            <div id="area-file">
                <input type="file" id="file-input" class="inp" accept=".pdf,.doc,.docx,.jpg,.png">
                <p style="font-size:0.75rem; color:#f59e0b; margin-top:-10px">Max size: 1MB (For Database)</p>
                <label style="color:#94a3b8; font-size:0.9rem"><input type="checkbox" id="allow-dl" checked> Allow Download?</label>
            </div>
            
            <div id="area-video" style="display:none">
                <input type="text" id="video-input" class="inp" placeholder="Paste YouTube or Drive Link">
                <p style="font-size:0.75rem; color:#f59e0b; margin-top:-10px">Storage is full/disabled. Use Links.</p>
            </div>

            <div id="area-post" style="display:none">
                <textarea id="post-input" class="inp" rows="3" placeholder="Description..."></textarea>
            </div>

            <p id="status-msg" style="text-align:center; color:#10b981; font-size:0.9rem"></p>

            <button onclick="submitUpload()" class="btn-action" style="margin-top:20px">Publish</button>
            <button onclick="closeModal('add-modal')" class="btn-action" style="background:transparent; color:#ef4444; margin-top:5px">Cancel</button>
        </div>
    </div>

    <div id="admin-modal" class="modal">
        <div class="modal-box">
            <h3 style="margin-top:0">Super Admin</h3>
            <div style="display:flex; gap:10px; margin-bottom:20px">
                <input id="new-admin-email" class="inp" style="margin:0" placeholder="User/Email">
                <select id="new-admin-role" class="inp" style="width:100px; margin:0; background:#0f172a">
                    <option value="admin">Admin</option>
                    <option value="super">Super</option>
                </select>
            </div>
            <button onclick="addNewAdmin()" class="btn-action">Add User</button>
            <hr style="border:0; border-top:1px solid #334155; margin:20px 0">
            <h4>Manage Years</h4>
            <div style="display:flex; gap:10px;">
                <input id="new-year-name" class="inp" style="margin:0" placeholder="Year Name">
                <button onclick="addNewYear()" class="btn-action" style="width:auto">+</button>
            </div>
            <button onclick="closeModal('admin-modal')" class="btn-action" style="background:#334155; margin-top:20px">Close</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2/tsparticles.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, deleteDoc, doc, setDoc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // CONFIG (NO STORAGE SDK)
        const firebaseConfig = {
            apiKey: "AIzaSyAAFzkX2hAgi6XXpZOGTeSQ5BBDwoyegCc",
            authDomain: "physics-84810.firebaseapp.com",
            projectId: "physics-84810",
            messagingSenderId: "402521782464",
            appId: "1:402521782464:web:b8887e4464b6055c70d525"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let state = { user: null, role: 'guest', year: 'y0', cat: 'c0', config: null };
        let uploadType = 'file';

        // INIT
        async function init() {
            onSnapshot(doc(db, "settings", "main"), async (snap) => {
                if(!snap.exists()) {
                    const def = {
                        years: [{id: 'y0', name: 'Prep Year'}, {id: 'y1', name: 'First Year'}, {id: 'y2', name: 'Second Year'}],
                        cats: [{id: 'c0', name: 'Lectures'}, {id: 'c1', name: 'Sections'}]
                    };
                    await setDoc(doc(db, "settings", "main"), def);
                    await setDoc(doc(db, "settings", "roles"), {'adhamsayed@physiatic.com': 'super'});
                } else {
                    state.config = snap.data();
                    renderNav(); renderTabs(); loadContent();
                }
            });
        }

        function renderNav() {
            const el = document.getElementById('nav-container'); el.innerHTML = '';
            state.config.years.forEach(y => {
                let icon = 'fa-folder';
                if(y.name.includes('Prep')) icon = 'fa-shapes';
                else if(y.name.includes('First')) icon = 'fa-drafting-compass';
                el.innerHTML += `<div class="nav-item ${y.id===state.year?'active':''}" onclick="setYear('${y.id}')"><i class="fas ${icon}"></i> ${y.name}</div>`;
            });
            updateTitle();
        }

        function renderTabs() {
            const el = document.getElementById('tabs-container'); el.innerHTML = '';
            state.config.cats.forEach(c => {
                el.innerHTML += `<div class="tab ${c.id===state.cat?'active':''}" onclick="setCat('${c.id}')">${c.name}</div>`;
            });
            updateTitle();
        }

        function updateTitle() {
            const y = state.config?.years.find(x => x.id === state.year)?.name || '';
            const c = state.config?.cats.find(x => x.id === state.cat)?.name || '';
            document.getElementById('page-title').innerText = `${y} | ${c}`;
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('open');
        }

        window.setYear = (id) => { state.year = id; renderNav(); loadContent(); }
        window.setCat = (id) => { state.cat = id; renderTabs(); loadContent(); }
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');

        // AUTH
        onAuthStateChanged(auth, async (user) => {
            state.user = user;
            if(user) {
                const roleSnap = await getDoc(doc(db, "settings", "roles"));
                state.role = (roleSnap.data() || {})[user.email.toLowerCase()] || 'guest';
                document.getElementById('btn-login').style.display = 'none';
                document.getElementById('btn-profile').style.display = 'flex';
                document.getElementById('user-role').innerText = state.role.toUpperCase();
                if(state.role !== 'guest') document.getElementById('fab').style.display = 'flex';
                if(state.role === 'super') document.getElementById('admin-panel-btn').style.display = 'flex';
            } else {
                state.role = 'guest';
                document.getElementById('btn-login').style.display = 'flex';
                document.getElementById('btn-profile').style.display = 'none';
                document.getElementById('fab').style.display = 'none';
                document.getElementById('admin-panel-btn').style.display = 'none';
            }
            loadContent();
        });

        window.handleLogin = async () => {
            let e = document.getElementById('login-email').value.trim();
            if(!e.includes('@')) e += '@physiatic.com';
            try { await signInWithEmailAndPassword(auth, e, document.getElementById('login-pass').value); closeModal('login-modal'); }
            catch(err) { alert("Error: "+err.message); }
        }

        // CONTENT (READ ONLY)
        function loadContent() {
            const grid = document.getElementById('content-grid');
            grid.innerHTML = '<p style="opacity:0.6; padding:10px">Syncing...</p>';
            const q = query(collection(db, "materials"), where("yearId", "==", state.year), where("catId", "==", state.cat), orderBy("createdAt", "desc"));
            
            onSnapshot(q, (snap) => {
                grid.innerHTML = '';
                if(snap.empty) { grid.innerHTML = '<p style="opacity:0.6; padding:10px">No content yet.</p>'; return; }
                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    let icon='fa-file-alt', cls='bg-file', btn;
                    if(d.type === 'video') { icon='fa-play'; cls='bg-vid'; }
                    else if(d.type === 'post') { icon='fa-bullhorn'; cls='bg-post'; }

                    if(d.type === 'post') btn = '';
                    else if(d.allowDL || state.role !== 'guest') btn = `<a href="${d.url}" target="_blank" class="btn-action">${d.type==='video'?'Watch':'Open/Download'}</a>`;
                    else btn = `<div class="btn-action btn-locked"><i class="fas fa-lock"></i> Locked</div>`;

                    const del = (state.role === 'admin' || state.role === 'super') ? `<i class="fas fa-trash" style="position:absolute; top:15px; right:15px; color:#ef4444; cursor:pointer" onclick="delItem('${docSnap.id}')"></i>` : '';
                    
                    grid.innerHTML += `<div class="card">${del}<div class="card-icon ${cls}"><i class="fas ${icon}"></i></div><h4>${d.title}</h4><p style="color:#94a3b8; font-size:0.85rem; margin-bottom:15px">${d.desc||''}</p>${btn}</div>`;
                });
            });
        }
        window.delItem = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, "materials", id)); }

        // UPLOAD (BASE64 & LINKS - NO STORAGE SDK)
        window.setUploadType = (t) => {
            uploadType = t;
            ['file','video','post'].forEach(x => {
                document.getElementById(`type-${x}`).style.background = x===t ? '#334155' : 'transparent';
                document.getElementById(`area-${x}`).style.display = x===t ? 'block' : 'none';
            });
        }

        window.submitUpload = async () => {
            const title = document.getElementById('upload-title').value;
            if(!title) return alert("Title required");
            
            const payload = { title, type: uploadType, yearId: state.year, catId: state.cat, createdAt: new Date() };

            if(uploadType === 'post') {
                payload.desc = document.getElementById('post-input').value;
                save(payload);
            } else if(uploadType === 'video') {
                payload.url = document.getElementById('video-input').value; // Save Link Directly
                payload.allowDL = true;
                if(!payload.url) return alert("Enter a Link");
                save(payload);
            } else {
                // FILE -> BASE64 (Database Storage)
                const file = document.getElementById('file-input').files[0];
                if(!file) return alert("Select File");
                if(file.size > 1000000) return alert("File too big for DB mode (Max 1MB). Use Link for large files.");
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    payload.url = e.target.result; // Base64 String
                    payload.allowDL = document.getElementById('allow-dl').checked;
                    payload.desc = "Document File";
                    save(payload);
                };
                reader.readAsDataURL(file);
            }
        }

        async function save(data) {
            document.getElementById('status-msg').innerText = "Saving to Database...";
            await addDoc(collection(db, "materials"), data);
            closeModal('add-modal');
            document.getElementById('status-msg').innerText = "";
            document.getElementById('upload-title').value = "";
        }

        // SUPER ADMIN
        window.addNewAdmin = async () => {
            let e = document.getElementById('new-admin-email').value;
            if(!e.includes('@')) e += '@physiatic.com';
            await updateDoc(doc(db, "settings", "roles"), { [e.toLowerCase()]: document.getElementById('new-admin-role').value });
            alert("User Added");
        }
        window.addNewYear = async () => {
            const val = document.getElementById('new-year-name').value;
            if(val) await updateDoc(doc(db, "settings", "main"), { years: arrayUnion({id: Date.now().toString(), name: val}) });
        }

        window.openLogin = () => document.getElementById('login-modal').style.display = 'flex';
        window.openAddModal = () => document.getElementById('add-modal').style.display = 'flex';
        window.openAdminModal = () => document.getElementById('admin-modal').style.display = 'flex';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        init();
        tsParticles.load("tsparticles", { fpsLimit: 60, particles: { color: { value: "#3b82f6" }, links: { color: "#3b82f6", distance: 150, enable: true, opacity: 0.1 }, move: { enable: true, speed: 0.5 }, number: { value: 50 }, opacity: 0.2, size: { value: { min: 1, max: 2 } } } });
    </script>
</body>
</html>
