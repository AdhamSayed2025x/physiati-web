<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhysiatiÄ‡ | Advanced Physics</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- General & Variables --- */
        :root { 
            --primary: #2d3436;      
            --accent: #2980b9;       
            --bg-light: #ffffff; 
            --bg-soft: #f9fbfd;
            --nav-hover: #eaf2f8;
            --glass: rgba(255, 255, 255, 0.95);
        }
        * { box-sizing: border-box; outline: none; }
        body { 
            margin: 0; font-family: 'Poppins', sans-serif; 
            background: var(--bg-light); color: var(--primary); 
            overflow-x: hidden; 
        }

        /* --- Animations --- */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-up { animation: fadeUp 0.8s ease-out forwards; opacity: 0; }
        .delay-1 { animation-delay: 0.2s; }
        .delay-2 { animation-delay: 0.4s; }

        /* --- Navigation --- */
        nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 8%; background: var(--glass); backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 1000;
            box-shadow: 0 2px 15px rgba(0,0,0,0.03);
        }
        .logo { font-size: 1.5rem; font-weight: 800; color: #2c3e50; cursor: pointer; }
        .nav-links { display: flex; gap: 10px; align-items: center; }
        .nav-link {
            text-decoration: none; color: #636e72; font-weight: 500;
            padding: 8px 16px; border-radius: 20px; transition: 0.3s; cursor: pointer;
        }
        .nav-link:hover, .nav-link.active-page { background: var(--nav-hover); color: var(--accent); }

        /* User Controls */
        .login-btn { border: 2px solid var(--accent); color: var(--accent); padding: 5px 20px; border-radius: 50px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .login-btn:hover { background: var(--accent); color: white; }
        
        .user-badge { display: none; align-items: center; gap: 10px; }
        .admin-tag { background: #e74c3c; color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; vertical-align: middle; }

        /* --- Content Sections --- */
        .hero { display: flex; align-items: center; justify-content: space-between; padding: 60px 8%; min-height: 85vh; }
        .hero-text h1 { font-size: 3.5rem; line-height: 1.2; margin-bottom: 20px; color: #1e272e; }
        .hero-img img { width: 100%; max-width: 600px; transition: 0.3s; cursor: default; }
        .hero-img img:hover { transform: scale(1.02); }

        .projects-wrapper { padding: 60px 8%; background: var(--bg-soft); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; }
        .card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.04); transition: 0.4s; }
        .card:hover { transform: translateY(-10px); }
        .card img { width: 100%; height: 180px; object-fit: cover; }
        .card-body { padding: 25px; }
        .card h3 { color: var(--accent); margin: 0 0 10px; }

        /* --- Login Modal --- */
        #login-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-box {
            background: white; padding: 40px; border-radius: 20px; width: 350px;
            text-align: center; position: relative; animation: fadeUp 0.3s;
        }
        .modal-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; }
        .pass-wrapper { position: relative; }
        .toggle-pass { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #888; }
        .close-modal { position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 1.2rem; }

        /* --- Admin Dashboard --- */
        #admin-panel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 3000;
            display: none; justify-content: center; align-items: center;
        }
        .dash-board {
            background: white; width: 90%; max-width: 1000px; height: 700px;
            border-radius: 20px; display: flex; overflow: hidden;
        }
        .sidebar { width: 250px; background: #2c3e50; color: white; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .sb-btn { padding: 15px; cursor: pointer; border-radius: 8px; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .sb-btn:hover, .sb-btn.active { background: var(--accent); }
        
        .dash-main { flex: 1; padding: 40px; background: #f4f6f8; overflow-y: auto; }
        .dash-section { display: none; }
        .dash-section.active-sec { display: block; }
        
        /* Edit Mode Styles */
        .editable { border: 2px dashed #e74c3c; background: rgba(231, 76, 60, 0.05); cursor: text; }
        .editable-img { border: 4px solid #e74c3c; opacity: 0.8; cursor: pointer !important; }
        
        #saveBtn {
            position: fixed; bottom: 30px; right: 30px; background: #27ae60;
            color: white; padding: 15px 35px; border-radius: 50px; border: none;
            font-weight: bold; cursor: pointer; box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
            display: none; z-index: 4000;
        }
        
        /* Team Manager Table */
        .team-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; }
        .team-table th, .team-table td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        .team-table th { background: #eee; }
    </style>
</head>
<body>

    <nav>
        <div class="logo" onclick="route('home')"><i class="fas fa-atom"></i> PhysiatiÄ‡</div>
        <div class="nav-links">
            <a onclick="route('home')" class="nav-link active-page">Home</a>
            <a onclick="route('topics')" class="nav-link">Topics</a>
            <a onclick="route('resources')" class="nav-link">Resources</a>
            <a onclick="route('about')" class="nav-link">About</a>
        </div>
        
        <div id="loggedOutUI">
            <button class="login-btn" onclick="openLogin()"><i class="fas fa-sign-in-alt"></i> Login</button>
        </div>

        <div id="loggedInUI" class="user-badge">
            <span id="userGreeting" style="font-weight:600;"></span>
            <button onclick="openDashboard()" style="background:var(--primary); color:white; border:none; padding:5px 15px; border-radius:15px; cursor:pointer;">
                <i class="fas fa-cog"></i> Dashboard
            </button>
            <i class="fas fa-power-off" onclick="performLogout()" style="color:red; cursor:pointer; margin-left:5px;" title="Logout"></i>
        </div>
    </nav>

    <div id="main-container">
        <div id="home" class="page-sec">
            <header class="hero">
                <div class="hero-text animate-up">
                    <h1 data-db="hero_title">Master the Art of <br><strong>Physical Science</strong></h1>
                    <p data-db="hero_desc" style="color:#636e72; font-size:1.1rem; margin-bottom:30px;">
                        The ultimate hub for engineering projects and research.
                    </p>
                    <button class="login-btn" style="background:var(--accent); color:white;">Start Exploring</button>
                </div>
                <div class="hero-img animate-up delay-1">
                    <img id="mainHeroImg" data-img="hero_img" src="hero-main.jpg" onerror="this.src='https://img.freepik.com/free-vector/science-lab-concept-illustration_114360-1090.jpg'" alt="Cover">
                </div>
            </header>

            <section class="projects-wrapper animate-up delay-2">
                <div style="text-align:center; margin-bottom:40px;">
                    <h2 data-db="proj_head">Featured Projects</h2>
                </div>
                <div class="grid">
                    <div class="card">
                        <img id="proj1Img" data-img="p1_img" src="https://m.media-amazon.com/images/I/71J1k7-w-LL.jpg" alt="Robot">
                        <div class="card-body">
                            <h3 data-db="p1_t">Line Follower Robot</h3>
                            <p data-db="p1_d">Autonomous robot tracking pathways with high precision.</p>
                        </div>
                    </div>
                    <div class="card">
                        <img id="proj2Img" data-img="p2_img" src="https://img.freepik.com/free-photo/electrical-components-circuit-board_23-2148290352.jpg" alt="Circuit">
                        <div class="card-body">
                            <h3 data-db="p2_t">Smart Circuitry</h3>
                            <p data-db="p2_d">Advanced PCB design for automation.</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div id="other-pages" class="page-sec" style="display:none; text-align:center; padding:100px;">
            <i class="fas fa-rocket" style="font-size:4rem; color:#ccc;"></i>
            <h2 style="margin-top:20px;">Coming Soon</h2>
            <p>We are building this section.</p>
        </div>
    </div>

    <div id="login-modal">
        <div class="modal-box">
            <i class="fas fa-times close-modal" onclick="closeLogin()"></i>
            <h2>Admin Access</h2>
            <input type="text" id="loginUser" placeholder="Username">
            <div class="pass-wrapper">
                <input type="password" id="loginPass" placeholder="Password">
                <i class="fas fa-eye toggle-pass" onclick="togglePass()"></i>
            </div>
            <button onclick="attemptLogin()" style="width:100%; padding:12px; background:var(--accent); color:white; border:none; border-radius:8px; margin-top:10px; cursor:pointer;">Login</button>
            <p id="loginError" style="color:red; display:none; margin-top:10px; font-size:0.9rem;">Wrong Credentials!</p>
        </div>
    </div>

    <div id="admin-panel">
        <div class="dash-board">
            <div class="sidebar">
                <h3>Control Panel</h3>
                <div class="sb-btn active" onclick="switchTab('content')"><i class="fas fa-pen"></i> Content</div>
                <div class="sb-btn" id="superAdminTab" style="display:none;" onclick="switchTab('team')"><i class="fas fa-users"></i> Team Manager</div>
                <div class="sb-btn" onclick="closeDashboard()" style="margin-top:auto; background:#c0392b;"><i class="fas fa-arrow-left"></i> Back to Site</div>
            </div>
            
            <div class="dash-main">
                <div id="tab-content" class="dash-section active-sec">
                    <h2>Website Content</h2>
                    <div style="background:white; padding:20px; border-radius:10px; margin-top:20px;">
                        <h4><i class="fas fa-magic"></i> Live Editor</h4>
                        <p>Click the button below. You can then click on any text OR image on the website to change it.</p>
                        <button onclick="enableLiveEdit()" style="padding:10px 20px; background:#27ae60; color:white; border:none; border-radius:5px; cursor:pointer;">
                            Enable Live Edit
                        </button>
                    </div>
                </div>

                <div id="tab-team" class="dash-section">
                    <h2>Manage Admins</h2>
                    <div style="background:white; padding:20px; border-radius:10px; margin-top:20px;">
                        <h4>Add New Admin</h4>
                        <input type="text" id="newAdminUser" placeholder="Username" style="width:30%; padding:8px;">
                        <input type="text" id="newAdminPass" placeholder="Password" style="width:30%; padding:8px;">
                        <button onclick="addNewAdmin()" style="padding:8px 20px; background:var(--accent); color:white; border:none; cursor:pointer;">Add</button>
                    </div>
                    
                    <h4 style="margin-top:30px;">Current Team</h4>
                    <table class="team-table">
                        <thead><tr><th>Name</th><th>Role</th><th>Action</th></tr></thead>
                        <tbody id="adminListBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <button id="saveBtn" onclick="saveChanges()"><i class="fas fa-save"></i> Save Changes</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAPTGbfFr2Cdr8d5DGDo_duwVevRxXm1bA",
            authDomain: "physiatic.firebaseapp.com",
            projectId: "physiatic",
            storageBucket: "physiatic.firebasestorage.app",
            messagingSenderId: "776862019288",
            appId: "1:776862019288:web:61d1947138a740369bb1ad"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- 1. SESSION MANAGEMENT (PERSISTENCE) ---
        // Check if user is already logged in from LocalStorage
        const savedUser = localStorage.getItem('physiatic_user');
        if(savedUser) {
            const user = JSON.parse(savedUser);
            setupLoggedInState(user);
        }

        // --- 2. AUTH FUNCTIONS ---
        window.attemptLogin = async function() {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            const err = document.getElementById('loginError');
            
            // Get admins from Firebase
            const docRef = doc(db, "settings", "admins");
            const docSnap = await getDoc(docRef);
            
            let adminList = [];
            if(docSnap.exists()) {
                adminList = docSnap.data().list || [];
            } else {
                // Initialize DB with Super Admin if empty
                adminList = [{u: "Adham", p: "20250003", role: "super_admin"}];
                await setDoc(docRef, { list: adminList });
            }

            const found = adminList.find(a => a.u === u && a.p === p);

            if(found) {
                // Save to LocalStorage (Persistence)
                localStorage.setItem('physiatic_user', JSON.stringify(found));
                setupLoggedInState(found);
                closeLogin();
            } else {
                err.style.display = 'block';
            }
        }

        function setupLoggedInState(user) {
            document.getElementById('loggedOutUI').style.display = 'none';
            document.getElementById('loggedInUI').style.display = 'flex';
            document.getElementById('userGreeting').innerHTML = 
                `Welcome Eng. ${user.u} ${user.role==='super_admin' ? '<span class="admin-tag">Super Admin</span>' : ''}`;
            
            // Show Team Tab only for Super Admin
            if(user.role === 'super_admin') {
                document.getElementById('superAdminTab').style.display = 'flex';
            }
        }

        window.performLogout = function() {
            if(confirm("Are you sure you want to logout?")) {
                localStorage.removeItem('physiatic_user');
                location.reload();
            }
        }

        // --- 3. TEAM MANAGER (SUPER ADMIN) ---
        window.loadTeam = async function() {
            const docRef = doc(db, "settings", "admins");
            onSnapshot(docRef, (doc) => {
                if(doc.exists()){
                    const list = doc.data().list;
                    const tbody = document.getElementById('adminListBody');
                    tbody.innerHTML = '';
                    list.forEach(a => {
                        const isMe = JSON.parse(localStorage.getItem('physiatic_user')).u === a.u;
                        tbody.innerHTML += `
                            <tr>
                                <td>${a.u}</td>
                                <td>${a.role === 'super_admin' ? 'ðŸ‘‘ Super Admin' : 'Admin'}</td>
                                <td>
                                    ${a.role !== 'super_admin' ? 
                                    `<button onclick="deleteAdmin('${a.u}')" style="color:red; border:1px solid red; background:white; cursor:pointer;">Remove</button>` 
                                    : '---'}
                                </td>
                            </tr>
                        `;
                    });
                }
            });
        }

        window.addNewAdmin = async function() {
            const u = document.getElementById('newAdminUser').value;
            const p = document.getElementById('newAdminPass').value;
            if(!u || !p) return alert("Fill fields!");

            const newAdmin = { u: u, p: p, role: "admin" };
            await updateDoc(doc(db, "settings", "admins"), {
                list: arrayUnion(newAdmin)
            });
            alert("Admin Added!");
            document.getElementById('newAdminUser').value = '';
            document.getElementById('newAdminPass').value = '';
        }

        window.deleteAdmin = async function(username) {
            if(!confirm("Remove this admin?")) return;
            // Need to fetch full object to remove
            const docRef = doc(db, "settings", "admins");
            const snap = await getDoc(docRef);
            const list = snap.data().list;
            const toRemove = list.find(a => a.u === username);
            
            if(toRemove) {
                await updateDoc(docRef, { list: arrayRemove(toRemove) });
            }
        }

        // --- 4. DATA SYNC (TEXT & IMAGES) ---
        const contentRef = doc(db, "site_data", "main_content");
        
        onSnapshot(contentRef, (docSnap) => {
            if (docSnap.exists() && !document.body.classList.contains('editing-mode')) {
                const data = docSnap.data();
                // Update Text
                document.querySelectorAll('[data-db]').forEach(el => {
                    const key = el.getAttribute('data-db');
                    if(data[key]) el.innerHTML = data[key];
                });
                // Update Images
                document.querySelectorAll('[data-img]').forEach(el => {
                    const key = el.getAttribute('data-img');
                    if(data[key]) el.src = data[key];
                });
            }
        });

        window.saveChanges = async function() {
            const btn = document.getElementById('saveBtn');
            btn.innerHTML = 'Saving...';
            
            let payload = {};
            // Gather Text
            document.querySelectorAll('[data-db]').forEach(el => {
                payload[el.getAttribute('data-db')] = el.innerHTML;
            });
            // Gather Images
            document.querySelectorAll('[data-img]').forEach(el => {
                payload[el.getAttribute('data-img')] = el.getAttribute('src');
            });

            try {
                await setDoc(contentRef, payload, {merge: true});
                alert("Saved & Published! ðŸš€");
                disableLiveEdit();
            } catch(e) { alert("Error: " + e.message); }
            btn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
        }

        // --- Expose functions to window for onclick ---
        if(localStorage.getItem('physiatic_user')) {
             const u = JSON.parse(localStorage.getItem('physiatic_user'));
             if(u.role === 'super_admin') loadTeam();
        }
    </script>

    <script>
        // UI Navigation
        function route(page) {
            document.querySelectorAll('.page-sec').forEach(d => d.style.display = 'none');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active-page'));
            
            if(page === 'home') {
                document.getElementById('home').style.display = 'block';
                document.querySelector('.nav-link').classList.add('active-page'); // highlight home
            } else {
                document.getElementById('other-pages').style.display = 'block';
            }
        }

        // Login UI
        function openLogin() { document.getElementById('login-modal').style.display = 'flex'; }
        function closeLogin() { document.getElementById('login-modal').style.display = 'none'; }
        function togglePass() {
            const inp = document.getElementById('loginPass');
            const icon = document.querySelector('.toggle-pass');
            if(inp.type === "password") { inp.type = "text"; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); }
            else { inp.type = "password"; icon.classList.add('fa-eye'); icon.classList.remove('fa-eye-slash'); }
        }

        // Dashboard
        function openDashboard() { 
            document.getElementById('admin-panel').style.display = 'flex'; 
            // Load team if super admin
            const u = JSON.parse(localStorage.getItem('physiatic_user'));
            if(u.role === 'super_admin') window.loadTeam();
        }
        function closeDashboard() { document.getElementById('admin-panel').style.display = 'none'; }
        
        function switchTab(tab) {
            document.querySelectorAll('.dash-section').forEach(s => s.classList.remove('active-sec'));
            document.querySelectorAll('.sb-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById('tab-'+tab).classList.add('active-sec');
            event.currentTarget.classList.add('active');
        }

        // EDIT MODE
        function enableLiveEdit() {
            closeDashboard();
            document.body.classList.add('editing-mode');
            document.getElementById('saveBtn').style.display = 'block';
            
            // Text Editable
            document.querySelectorAll('[data-db]').forEach(el => {
                el.contentEditable = "true";
                el.classList.add('editable');
            });

            // Image Editable
            document.querySelectorAll('[data-img]').forEach(el => {
                el.classList.add('editable-img');
                el.onclick = function(e) {
                    if(!document.body.classList.contains('editing-mode')) return;
                    e.preventDefault();
                    const newUrl = prompt("Enter new Image URL:", el.src);
                    if(newUrl) el.src = newUrl;
                }
            });

            alert("âœï¸ Live Edit ON\n- Click text to type.\n- Click images to change URL.");
        }

        function disableLiveEdit() {
            document.body.classList.remove('editing-mode');
            document.getElementById('saveBtn').style.display = 'none';
            document.querySelectorAll('[data-db]').forEach(el => {
                el.contentEditable = "false";
                el.classList.remove('editable');
            });
            document.querySelectorAll('[data-img]').forEach(el => {
                el.classList.remove('editable-img');
                el.onclick = null;
            });
        }
    </script>
</body>
    </html>
