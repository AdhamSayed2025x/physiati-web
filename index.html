<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physiatić | المنصة الأكاديمية</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* === 1. CSS VARIABLES & RESET === */
        :root {
            --bg-dark: #0f172a;
            --bg-light: #f1f5f9;
            --text-dark: #f8fafc;
            --text-light: #1e293b;
            --accent: #3b82f6;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --card-glass: rgba(15, 23, 42, 0.6);
            --success: #10b981;
            --danger: #ef4444;
        }

        [data-theme="light"] {
            --bg-color: var(--bg-light);
            --text-color: var(--text-light);
            --glass-bg: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(0, 0, 0, 0.05);
            --card-glass: rgba(255, 255, 255, 0.7);
        }

        [data-theme="dark"] {
            --bg-color: var(--bg-dark);
            --text-color: var(--text-dark);
            --glass-bg: rgba(15, 23, 42, 0.6);
            --card-glass: rgba(30, 41, 59, 0.7);
        }

        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        body { margin: 0; font-family: 'Cairo', sans-serif; background: var(--bg-color); color: var(--text-color); overflow-x: hidden; height: 100vh; }

        /* === 2. PARTICLES BACKGROUND === */
        #tsparticles { position: fixed; width: 100%; height: 100%; z-index: -1; top: 0; left: 0; }

        /* === 3. LAYOUT STRUCTURE === */
        .app-container { display: flex; height: 100vh; position: relative; z-index: 1; }

        /* Sidebar (Years) */
        .sidebar {
            width: 260px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-left: 1px solid var(--glass-border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .logo {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
            text-align: center;
            letter-spacing: 1px;
        }

        .nav-item {
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-color);
            opacity: 0.7;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(59, 130, 246, 0.15);
            opacity: 1;
            transform: translateX(-5px);
            border-right: 3px solid var(--accent);
        }

        /* Main Content */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }

        /* Top Header (Categories) */
        .header-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
            overflow-x: auto;
        }

        .tab {
            padding: 10px 20px;
            border-radius: 50px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            cursor: pointer;
            white-space: nowrap;
        }

        .tab.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }

        /* Cards Grid (Materials) */
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .material-card {
            background: var(--card-glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.5s ease-up;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .card-icon {
            font-size: 40px;
            margin-bottom: 15px;
            color: var(--accent);
        }

        .card-title { font-weight: bold; font-size: 1.1em; margin-bottom: 10px; }
        .card-meta { font-size: 0.85em; opacity: 0.6; display: flex; justify-content: space-between; }
        
        .action-btn {
            margin-top: 15px;
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            border: none;
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent);
            cursor: pointer;
            font-weight: bold;
        }
        .action-btn:hover { background: var(--accent); color: white; }

        .delete-btn { position: absolute; top: 15px; left: 15px; color: var(--danger); cursor: pointer; opacity: 0; }
        .material-card:hover .delete-btn { opacity: 1; }

        /* === 4. FAB (Floating Action Button) for Admin === */
        .fab {
            position: fixed;
            bottom: 40px;
            left: 40px;
            width: 60px;
            height: 60px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.5);
            cursor: pointer;
            z-index: 100;
        }
        .fab:hover { transform: scale(1.1) rotate(90deg); }

        /* === 5. MODAL === */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 200; display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background: #1e293b; width: 90%; max-width: 500px;
            padding: 30px; border-radius: 20px; border: 1px solid var(--glass-border);
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; color: #94a3b8; }
        .form-input { 
            width: 100%; padding: 12px; background: #0f172a; 
            border: 1px solid #334155; border-radius: 8px; color: white; outline: none; 
        }
        .upload-area {
            border: 2px dashed #334155; padding: 30px; text-align: center;
            border-radius: 10px; cursor: pointer; margin-bottom: 15px;
        }
        .upload-area:hover { border-color: var(--accent); background: rgba(59, 130, 246, 0.05); }

    </style>
</head>
<body data-theme="dark">

    <div id="tsparticles"></div>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top: 0; color: white;">إضافة محتوى جديد <i class="fas fa-atom fa-spin" style="color:var(--accent)"></i></h2>
            
            <div class="form-group">
                <label>عنوان الملف / الفيديو</label>
                <input type="text" id="fileTitle" class="form-input" placeholder="مثال: محاضرة الفيزياء النووية 1">
            </div>

            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt" style="font-size: 30px; color: var(--accent);"></i>
                <p>اضغط لرفع ملف (PDF, PPT, IMG)</p>
                <input type="file" id="fileInput" style="display: none">
                <span id="fileName" style="font-size: 12px; color: var(--success);"></span>
            </div>

            <div class="form-group">
                <label>أو رابط خارجي (يوتيوب / درايف)</label>
                <input type="text" id="fileUrl" class="form-input" placeholder="https://...">
            </div>

            <div style="display: flex; gap: 10px;">
                <button onclick="saveContent()" class="action-btn" style="background: var(--accent); color: white;">نشر الآن</button>
                <button onclick="closeModal()" class="action-btn" style="background: var(--danger); color: white;">إلغاء</button>
            </div>
            <p id="uploadStatus" style="text-align: center; margin-top: 10px; font-size: 0.9em;"></p>
        </div>
    </div>

    <div class="app-container">
        
        <aside class="sidebar">
            <div class="logo">PHYSIATIĆ</div>
            
            <div class="nav-item active" onclick="setYear('prep')">
                <i class="fas fa-graduation-cap"></i> إعدادي هندسة
            </div>
            <div class="nav-item" onclick="setYear('year1')">
                <i class="fas fa-1"></i> الفرقة الأولى
            </div>
            <div class="nav-item" onclick="setYear('year2')">
                <i class="fas fa-2"></i> الفرقة الثانية
            </div>
            <div class="nav-item" onclick="setYear('year3')">
                <i class="fas fa-3"></i> الفرقة الثالثة
            </div>
            <div class="nav-item" onclick="setYear('year4')">
                <i class="fas fa-4"></i> الفرقة الرابعة
            </div>

            <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--glass-border);">
                 <div class="nav-item" onclick="toggleTheme()">
                    <i class="fas fa-moon" id="themeIcon"></i> وضع الرؤية
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div class="header-tabs">
                <div class="tab active" onclick="setCategory('lectures')">محاضرات</div>
                <div class="tab" onclick="setCategory('sections')">سكاشن</div>
                <div class="tab" onclick="setCategory('assignments')">شيتات وأبحاث</div>
                <div class="tab" onclick="setCategory('projects')">مشاريع</div>
                <div class="tab" onclick="setCategory('grades')">درجات أعمال السنة</div>
            </div>

            <div id="contentGrid" class="content-grid">
                <div style="grid-column: 1/-1; text-align: center; margin-top: 50px; opacity: 0.5;">
                    <i class="fas fa-spinner fa-spin fa-3x"></i>
                    <p>جارِ تحميل البيانات من السيرفر...</p>
                </div>
            </div>
        </main>

        <div class="fab" onclick="openModal()">
            <i class="fas fa-plus"></i>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2/tsparticles.bundle.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // 1. Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAAFzkX2hAgi6XXpZOGTeSQ5BBDwoyegCc",
            authDomain: "physics-84810.firebaseapp.com",
            projectId: "physics-84810",
            storageBucket: "physics-84810.firebasestorage.app",
            messagingSenderId: "402521782464",
            appId: "1:402521782464:web:b8887e4464b6055c70d525"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // 2. State Management (المتغيرات الحالية)
        let currentYear = 'prep';
        let currentCategory = 'lectures';

        // 3. UI Functions (التحكم في الواجهة)
        window.setYear = (year) => {
            currentYear = year;
            updateUIState('.nav-item', year);
            loadContent();
        }

        window.setCategory = (cat) => {
            currentCategory = cat;
            // تحديث كلاس active
            document.querySelectorAll('.tab').forEach(el => {
                if(el.innerText.includes(getCatName(cat))) el.classList.add('active'); // تبسيط
                else el.classList.remove('active');
            });
            // إعادة تلوين التابات يدوياً للسهولة في المثال
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach((t, index) => {
                const categories = ['lectures', 'sections', 'assignments', 'projects', 'grades'];
                if(categories[index] === cat) {
                    tabs.forEach(x => x.classList.remove('active'));
                    t.classList.add('active');
                }
            });
            loadContent();
        }

        function getCatName(cat) {
            // دالة مساعدة
            return ''; 
        }

        function updateUIState(selector, value) {
            // تحديث بسيط للقوائم
            document.querySelectorAll(selector).forEach(el => el.classList.remove('active'));
            // في تطبيق حقيقي نستخدم IDs
            event.currentTarget.classList.add('active');
        }

        // 4. Modal Functions (النافذة المنبثقة)
        window.openModal = () => document.getElementById('addModal').style.display = 'flex';
        window.closeModal = () => document.getElementById('addModal').style.display = 'none';

        // 5. Logic: Upload & Save (قلب المشروع)
        window.saveContent = async () => {
            const title = document.getElementById('fileTitle').value;
            const fileInput = document.getElementById('fileInput').files[0];
            const urlInput = document.getElementById('fileUrl').value;
            const status = document.getElementById('uploadStatus');

            if (!title) { alert('اكتب عنوان للملف يا دكتور!'); return; }

            status.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> جارِ الرفع والحفظ...';

            try {
                let finalUrl = urlInput;
                let fileType = 'link';

                // لو اختار ملف، نرفعه الأول للستورج
                if (fileInput) {
                    fileType = 'file';
                    const storageRef = ref(storage, `materials/${currentYear}/${fileInput.name}`);
                    await uploadBytes(storageRef, fileInput);
                    finalUrl = await getDownloadURL(storageRef);
                }

                // حفظ البيانات في قاعدة البيانات
                await addDoc(collection(db, "materials"), {
                    title: title,
                    url: finalUrl,
                    type: fileType,
                    year: currentYear,
                    category: currentCategory,
                    createdAt: serverTimestamp()
                });

                status.innerHTML = 'تم الحفظ بنجاح!';
                closeModal();
                // تنظيف الفورم
                document.getElementById('fileTitle').value = '';
                document.getElementById('fileUrl').value = '';
                document.getElementById('fileName').innerText = '';

            } catch (error) {
                console.error("Error:", error);
                status.innerHTML = 'حصل خطأ: ' + error.message;
            }
        };

        // عرض اسم الملف عند الاختيار
        document.getElementById('fileInput').addEventListener('change', function(){
            if(this.files[0]) document.getElementById('fileName').innerText = this.files[0].name;
        });

        // 6. Logic: Load Content (قراءة البيانات)
        function loadContent() {
            const grid = document.getElementById('contentGrid');
            grid.innerHTML = ''; // تفريغ القديم

            // الاستعلام: هاتلي المواد بتاعت السنة دي والقسم ده
            const q = query(
                collection(db, "materials"), 
                where("year", "==", currentYear),
                where("category", "==", currentCategory),
                orderBy("createdAt", "desc")
            );

            // استماع لحظي (Realtime)
            onSnapshot(q, (snapshot) => {
                grid.innerHTML = '';
                if(snapshot.empty) {
                    grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:#64748b">
                        <i class="fas fa-box-open fa-3x"></i><br>لا يوجد محتوى مضاف هنا بعد
                    </div>`;
                    return;
                }

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const icon = data.type === 'file' ? 'fa-file-pdf' : 'fa-video';
                    
                    const card = `
                        <div class="material-card">
                            <i class="fas fa-trash delete-btn" onclick="deleteMaterial('${docSnap.id}')"></i>
                            <div class="card-icon"><i class="fas ${icon}"></i></div>
                            <div class="card-title">${data.title}</div>
                            <div class="card-meta">
                                <span>${new Date(data.createdAt?.seconds * 1000).toLocaleDateString('ar-EG')}</span>
                                <span>${data.type === 'file' ? 'تحميل' : 'مشاهدة'}</span>
                            </div>
                            <a href="${data.url}" target="_blank">
                                <button class="action-btn">فتح المحتوى</button>
                            </a>
                        </div>
                    `;
                    grid.innerHTML += card;
                });
            });
        }

        // حذف المحتوى
        window.deleteMaterial = async (id) => {
            if(confirm('هل أنت متأكد أنك تريد حذف هذا الملف؟')) {
                await deleteDoc(doc(db, "materials", id));
            }
        }

        // تشغيل التحميل الأولي
        loadContent();

        // 7. Particles Config (الخلفية المتحركة)
        tsParticles.load("tsparticles", {
            fpsLimit: 60,
            particles: {
                color: { value: "#3b82f6" }, // لون الذرات
                links: { color: "#3b82f6", distance: 150, enable: true, opacity: 0.3, width: 1 },
                move: { enable: true, speed: 1.5 },
                number: { value: 70 },
                opacity: { value: 0.5 },
                size: { value: { min: 1, max: 3 } }
            },
            interactivity: {
                events: { onHover: { enable: true, mode: "grab" } },
                modes: { grab: { distance: 140, links: { opacity: 1 } } }
            }
        });

        // Toggle Theme
        window.toggleTheme = () => {
            const body = document.body;
            const isDark = body.getAttribute('data-theme') === 'dark';
            body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('themeIcon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }
    </script>
</body>
</html>
