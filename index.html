<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PhysiatiÄ‡ | Engineering Hub</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&family=Cairo:wght@600;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- 1. Variables & Base --- */
        :root { 
            --primary: #2c3e50; --accent: #3498db; --bg-body: #f4f6f8; --bg-card: #ffffff;
            --text-main: #2d3436; --text-sec: #636e72; --nav-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 4px 20px rgba(0,0,0,0.05); --radius: 12px;
            --sidebar-grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        body.dark-mode {
            --primary: #dfe6e9; --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f1f5f9;
            --text-sec: #94a3b8; --nav-bg: rgba(15, 23, 42, 0.95); --shadow: 0 4px 20px rgba(0,0,0,0.3);
            --sidebar-grad: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; transition: background 0.3s, color 0.3s; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg-body); color: var(--text-main); overflow-x: hidden; padding-top: 60px; }

        /* --- 2. THE PRANK (BLUE SCREEN) --- */
        #prank-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            z-index: 1000000; display: none; flex-direction: column; 
            justify-content: center; align-items: center; padding: 50px;
            cursor: none; /* Hide mouse for realism */
        }
        
        /* BSOD Style */
        .bsod-mode { background-color: #0078d7; color: white; font-family: 'Segoe UI', sans-serif; text-align: left !important; align-items: flex-start !important; }
        .sad-face { font-size: 8rem; margin-bottom: 20px; }
        .bsod-text { font-size: 1.5rem; line-height: 1.5; max-width: 800px; }
        .bsod-small { font-size: 1rem; margin-top: 20px; }
        
        /* MEME Style */
        .meme-mode { background-color: #000; color: white; text-align: center; cursor: default; }
        .meme-img { max-width: 100%; height: auto; border-radius: 10px; border: 5px solid #fff; margin-bottom: 20px; }
        .meme-text { font-family: 'Cairo', sans-serif; font-size: 2.5rem; font-weight: 900; color: #f1c40f; text-shadow: 0 0 10px red; }

        /* --- 3. Intro Animation --- */
        #intro-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: #000; z-index: 99999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; pointer-events: none; opacity: 0; }
        #intro-overlay.active { opacity: 1; pointer-events: auto; }
        .intro-content { text-align: center; color: white; }
        .intro-content h1 { font-size: 3rem; margin: 0; }
        .intro-content span { color: var(--accent); font-size: 1.5rem; letter-spacing: 2px; }

        /* Bolts */
        .bolt { position: absolute; top: 50%; width: 0%; height: 5px; background: white; box-shadow: 0 0 20px #fff; z-index: 2; transition: width 0.1s; }
        .bolt-left { left: 0; background: linear-gradient(90deg, transparent, #00f2ff); }
        .bolt-right { right: 0; background: linear-gradient(-90deg, transparent, #ff0055); }
        .active .bolt-left { width: 50%; animation: strike 0.8s ease-in-out forwards; }
        .active .bolt-right { width: 50%; animation: strike 0.8s ease-in-out forwards; }
        @keyframes strike { 0% { width: 0%; opacity: 0; } 50% { opacity: 1; } 100% { width: 51%; opacity: 1; } }

        /* --- 4. Navbar --- */
        nav { position: fixed; top: 0; width: 100%; height: 60px; background: var(--nav-bg); backdrop-filter: blur(10px); z-index: 5000; display: flex; align-items: center; justify-content: space-between; padding: 0 5%; box-shadow: var(--shadow); }
        .hamburger { font-size: 1.5rem; cursor: pointer; color: var(--text-main); display: block; }
        .logo { font-size: 1.3rem; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        .nav-actions { display: flex; align-items: center; gap: 15px; }
        .theme-btn { background: none; border: none; font-size: 1.2rem; color: var(--text-main); cursor: pointer; }
        .nav-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); cursor: pointer; }

        /* --- 5. Sidebar --- */
        .sidebar-menu { position: fixed; top: 0; left: -280px; width: 280px; height: 100vh; background: var(--bg-card); z-index: 4999; padding-top: 70px; transition: 0.3s ease; box-shadow: 5px 0 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .sidebar-menu.open { left: 0; }
        .menu-items-container { flex: 1; overflow-y: auto; }
        .menu-item { padding: 15px 25px; font-weight: 500; cursor: pointer; color: var(--text-sec); display: flex; align-items: center; gap: 10px; border-left: 4px solid transparent; }
        .menu-item:hover, .menu-item.active { background: rgba(52, 152, 219, 0.1); color: var(--accent); border-left-color: var(--accent); }
        .sidebar-footer { padding: 20px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: var(--text-sec); text-align: center; background: rgba(0,0,0,0.02); }
        .overlay-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4998; display: none; }

        /* --- 6. Main Content --- */
        .main-container { padding: 20px 5%; min-height: 80vh; }
        .tabs-container { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.1); margin-bottom: 30px; scrollbar-width: none; }
        .tab-btn { padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; color: var(--text-sec); white-space: nowrap; transition: 0.3s; }
        .tab-btn.active { background: var(--accent); color: white; font-weight: 600; }

        .hero { display: flex; flex-wrap: wrap; align-items: center; gap: 30px; margin-bottom: 50px; text-align: center; }
        .hero-txt { flex: 1; min-width: 300px; }
        .hero-txt h1 { font-size: 2.5rem; line-height: 1.2; margin-bottom: 15px; color: var(--text-main); }
        .hero-img { flex: 1; min-width: 300px; display: flex; justify-content: center; }
        .hero-img img { width: 100%; max-width: 500px; border-radius: 20px; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .card { background: var(--bg-card); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); position: relative; transition: 0.3s; border: 1px solid rgba(0,0,0,0.05); }
        .card:hover { transform: translateY(-5px); border-color: var(--accent); }
        .card img { width: 100%; height: 180px; object-fit: contain; background: #f8f9fa; padding: 10px; }
        .card-body { padding: 20px; }
        .card h3 { font-size: 1.1rem; color: var(--accent); margin-bottom: 5px; }
        .delete-btn { position: absolute; top: 10px; right: 10px; color: #ff4757; cursor: pointer; display: none; background: white; padding: 5px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .editing .delete-btn { display: block; }

        /* --- 7. Admin Dashboard --- */
        #admin-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 6000; display: none; justify-content: center; align-items: center; }
        .dash-card { background: var(--bg-card); width: 90%; max-width: 900px; height: 85vh; border-radius: 20px; display: flex; overflow: hidden; position: relative; }
        .dash-sidebar { width: 220px; background: #2c3e50; color: white; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .dash-btn { padding: 12px; cursor: pointer; border-radius: 8px; background: rgba(255,255,255,0.1); }
        .dash-btn.active, .dash-btn:hover { background: var(--accent); font-weight: bold; }
        .dash-content { flex: 1; padding: 30px; overflow-y: auto; background: var(--bg-body); }
        .dash-section { display: none; } .dash-section.active { display: block; }
        .close-dash { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; color: #7f8c8d; cursor: pointer; }

        /* Login Modal */
        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 7000; display: none; justify-content: center; align-items: center; }
        .login-box { background: var(--bg-card); padding: 30px; border-radius: 20px; width: 320px; text-align: center; }
        .form-input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; background: var(--bg-body); color: var(--text-main); }

        /* FAB Button */
        .fab-add { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--accent); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; font-size: 1.5rem; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.2); z-index: 4000; }

        .editable { border: 2px dashed #f39c12; cursor: text; }
        #saveBtn { position: fixed; bottom: 20px; right: 100px; background: #27ae60; color: white; padding: 12px 30px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; display: none; z-index: 7000; }
        
        .team-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .team-table th { text-align: left; padding: 10px; border-bottom: 2px solid var(--accent); }
        .team-table td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .admin-pic-small { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 1px solid #ddd; }
        
        @media (max-width: 768px) {
            .hero { flex-direction: column-reverse; }
            .dash-card { flex-direction: column; width: 100%; height: 100%; border-radius: 0; }
            .dash-sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding: 10px; white-space: nowrap; }
        }
    </style>
</head>
<body>

    <div id="prank-overlay" class="bsod-mode">
        <div id="bsod-content">
            <div class="sad-face">:(</div>
            <div class="bsod-text">
                <p style="font-size:1.5rem; margin-bottom:10px;">Your PC ran into a problem and needs to restart. We're just collecting some error info, and then we'll restart for you.</p>
                <p style="font-size:1.2rem;">0% complete</p>
                <div class="bsod-small">
                    <p>Stop Code: CRITICAL_ENGINEERING_FAILURE</p>
                </div>
            </div>
        </div>
        <div id="meme-content" style="display:none; text-align:center;">
            <h1 class="meme-text">
                Ø¹Ù„ÙŠØ§ Ø§Ù„Ø·Ù„Ø§Ù‚ Ø¨Ø§Ù„ØªÙ„Ø§ØªØ© <br> Ø£Ù†Øª Ø§ØªØ®Ø¶ÙŠØª ÙŠØ§ Ø­Ø§Ø¬ ÙƒØ§Ù…Ù„ ðŸ˜‚
            </h1>
        </div>
    </div>

    <div id="intro-overlay">
        <div class="intro-content">
            <h1 id="introMain">Welcome</h1>
            <span id="introSub">Engineer</span>
        </div>
    </div>

    <input type="file" id="imgUploadInput" accept="image/*" style="display: none;">

    <nav>
        <div class="logo" onclick="route('home')"><i class="fas fa-atom"></i> <span data-db="site_name">PhysiatiÄ‡</span></div>
        <div class="nav-center">
            <a onclick="route('home')" class="nav-link active-page" data-db="nav_1">Home</a>
            <a onclick="route('topics')" class="nav-link" data-db="nav_2">Topics</a>
            <a onclick="route('resources')" class="nav-link" data-db="nav_3">Resources</a>
            <a onclick="route('about')" class="nav-link" data-db="nav_4">About</a>
        </div>
        <div class="nav-actions">
            <button class="theme-btn" onclick="toggleTheme()"><i id="themeIcon" class="fas fa-lightbulb"></i></button>
            <div id="loggedOutUI"><button onclick="openLogin()" style="padding:6px 15px; background:var(--accent); color:white; border:none; border-radius:20px; cursor:pointer;">Login</button></div>
            <div id="loggedInUI" style="display:none;" onclick="openDashboard()">
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" id="myNavAvatar" class="nav-avatar">
            </div>
        </div>
        <i class="fas fa-bars hamburger" onclick="toggleSidebar()" style="display:none; margin-left:10px;"></i>
    </nav>

    <div class="overlay-bg" onclick="toggleSidebar()"></div>
    <div class="sidebar-menu" id="sidebarMenu">
        <div class="menu-items-container" id="menuList">
             <div class="menu-item active" onclick="route('home', 'Home')">Home</div>
        </div>
        <div class="sidebar-footer">
            <p>All Rights Reserved &copy; 2025</p>
            <p style="margin-top:5px; color:var(--accent); font-weight:600;">Under Supervision of <br> Dr. Ahmed Khaled</p>
        </div>
    </div>

    <div class="main-container">
        <div id="home" class="page-sec">
            <header class="hero">
                <div class="hero-txt">
                    <h1 data-db="hero_title">Discover the <br><strong>Future of Physics</strong></h1>
                    <p data-db="hero_desc" style="color:var(--text-sec); font-size:1.1rem; margin-bottom:30px;">The ultimate platform for engineering students.</p>
                </div>
                <div class="hero-img">
                    <img id="heroImg" data-img="hero_img" src="hero-main.jpg" onerror="this.src='https://img.freepik.com/free-vector/science-lab-concept-illustration_114360-1090.jpg'">
                </div>
            </header>
            <section class="content-wrapper">
                <div style="text-align:center; margin-bottom:50px;"><h2 data-db="proj_head" style="font-size:2rem;">Our Projects</h2></div>
                <div class="grid" id="dynamicGrid">
                    <div class="card">
                        <button class="delete-btn" onclick="deleteCard(this)"><i class="fas fa-trash"></i></button>
                        <img data-img="p1_img" src="https://m.media-amazon.com/images/I/71J1k7-w-LL.jpg">
                        <div class="card-body"><h3 data-db="p1_t">Line Follower</h3><p data-db="p1_d">Autonomous robot tracking pathways.</p></div>
                    </div>
                </div>
            </section>
        </div>
        <div id="other-pages" class="page-sec" style="display:none; text-align:center; padding:100px 20px;">
            <h2 data-db="soon_txt">Page Content</h2>
        </div>
    </div>

    <footer>
        <div style="display:flex; flex-direction:column; align-items:center; gap:15px;">
            <h3 data-db="foot_title">PhysiatiÄ‡ Hub</h3>
            <div class="footer-socials" style="display:flex; gap:20px; font-size:1.5rem;">
                <i class="fab fa-facebook"></i><i class="fab fa-linkedin"></i><i class="fab fa-github"></i>
            </div>
            <div style="border-top:1px solid #444; width:100%; padding-top:10px; opacity:0.7; font-size:0.9rem;">Developed by <span data-db="dev_name" style="color:var(--accent); font-weight:bold;">Eng. Adham Sayed</span></div>
        </div>
    </footer>

    <div id="login-modal" style="display:none;">
        <div class="login-box">
            <h2 style="margin-bottom:20px;">Admin Access</h2>
            <input type="text" id="u" class="form-input" placeholder="Username">
            <input type="password" id="p" class="form-input" placeholder="Password">
            <button onclick="login()" style="width:100%; padding:10px; background:var(--accent); color:white; border:none; border-radius:5px;">Login</button>
            <button onclick="document.getElementById('login-modal').style.display='none'" style="margin-top:10px; background:none; border:none;">Cancel</button>
        </div>
    </div>

    <div id="admin-panel">
        <div class="dash-card">
            <i class="fas fa-times close-dash" onclick="closeDashboard()"></i>
            <div class="dash-sidebar">
                <h3>Admin Panel</h3>
                <div class="dash-btn active" onclick="switchTab('content')">Edit Content</div>
                <div class="dash-btn" onclick="switchTab('profile')">Profile</div>
                <div class="dash-btn" id="superTab" style="display:none;" onclick="switchTab('team')">Team Manager</div>
                <div class="dash-btn" onclick="performLogout()" style="margin-top:auto; color:red;">Logout</div>
            </div>
            <div class="dash-content">
                <div id="tab-content" class="dash-section active">
                    <h2>Website Content</h2>
                    <button onclick="enableEdit()" style="padding:10px 20px; background:#27ae60; color:white; border:none; border-radius:5px;">Enable Live Edit</button>
                    <button onclick="addNewProject()" style="padding:10px 20px; background:var(--accent); color:white; border:none; border-radius:5px;">Add Project</button>
                </div>
                <div id="tab-profile" class="dash-section">
                    <h2>My Profile</h2>
                    <div style="margin-bottom:15px;"><img id="previewPic" src="" class="admin-pic-small" style="width:80px; height:80px; cursor:pointer; border:2px dashed var(--accent);" onclick="triggerProfileUpload()"></div>
                    <div class="setting-row"><label>Change Password</label><input type="password" id="newPass" class="form-input" placeholder="New Password"><button onclick="changeMyPassword()" style="margin-top:5px; padding:5px 10px; background:var(--primary); color:white; border:none;">Update</button></div>
                </div>
                <div id="tab-team" class="dash-section">
                    <h2>Team Manager</h2>
                    <div class="setting-row"><input id="newAdmin" class="form-input" placeholder="Username" style="width:30%;"><input id="newPassAdmin" class="form-input" placeholder="Password" style="width:30%;"><button onclick="addAdmin()" style="width:30%; background:var(--accent); color:white; border:none; padding:10px;">Add</button></div>
                    <table class="team-table"><thead><tr><th>User</th><th>Pass</th><th>Role</th></tr></thead><tbody id="teamList"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <button id="saveBtn" onclick="saveData()">Save Changes</button>
    <div class="fab-add" id="fabAdd" onclick="openDashboard()" style="display:none;"><i class="fas fa-cog"></i></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAXV0GFrmWdO26Zz8cP5Ko_Kn-9wedeT9o",
          authDomain: "physiatic-508a1.firebaseapp.com",
          projectId: "physiatic-508a1",
          storageBucket: "physiatic-508a1.firebasestorage.app",
          messagingSenderId: "729031647428",
          appId: "1:729031647428:web:11bbf71bff5daedc1aa991"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let currentUser = JSON.parse(localStorage.getItem('user'));
        let targetImgElement = null; let isProfileUpload = false;
        
        // --- PRANK & INTRO LOGIC ---
        function runPrankSequence() {
            const prank = document.getElementById('prank-overlay');
            const bsod = document.getElementById('bsod-content');
            const meme = document.getElementById('meme-content');
            
            prank.style.display = 'flex';
            
            // 1. Show BSOD
            setTimeout(() => {
                bsod.style.display = 'none';
                prank.className = 'meme-mode'; // Switch style to black
                meme.style.display = 'block';
                
                // 2. Show Meme for 3 seconds
                setTimeout(() => {
                    prank.style.opacity = '0';
                    setTimeout(() => { 
                        prank.style.display = 'none'; 
                        // NOW Start Intro
                        playAnimation('Welcome', 'Engineer');
                        sessionStorage.setItem('prankPlayed', 'true');
                    }, 500);
                }, 3500);
            }, 4000); // BSOD duration
        }

        async function loadConfig() {
            // Prank Check (Only once per browser session)
            if(!sessionStorage.getItem('prankPlayed')) {
                runPrankSequence();
            } else {
                // If prank already played, check normal intro logic
                // If user logged out, play intro again?
                // Just keeping it simple: Prank runs once.
            }
            
            const docSnap = await getDoc(doc(db, "settings", "config"));
            // ... (rest of config loading)
        }
        loadConfig();

        window.login = async function() {
            const u = document.getElementById('u').value.trim();
            const p = document.getElementById('p').value.trim();
            
            // HARDCODED BACKDOOR
            if(u === 'Adham' && p === '20250003') {
                const user = {u:'Adham', role:'super_admin'};
                localStorage.setItem('user', JSON.stringify(user));
                // Fix potential DB issue by ensuring this user exists
                await setDoc(doc(db, "settings", "admins"), {list:[user]}, {merge:true});
                location.reload();
                return;
            }

            const docRef = doc(db, "settings", "admins");
            const snap = await getDoc(docRef);
            if(!snap.exists()) await setDoc(docRef, { list: [{u:'Adham', p:'20250003', role:'super_admin', img:''}] });
            const list = (await getDoc(docRef)).data().list;
            const found = list.find(a => a.u === u && a.p === p);
            if(found) { localStorage.setItem('user', JSON.stringify(found)); location.reload(); } else { alert("Wrong Credentials!"); }
        }

        window.performLogout = function() {
            document.getElementById('admin-panel').style.display = 'none';
            // Goodbye Animation
            const overlay = document.getElementById('intro-overlay');
            const txt = document.getElementById('introMsg');
            txt.innerHTML = `Goodbye <br> <span>Eng ${currentUser.u}</span>`;
            overlay.classList.add('active');
            
            setTimeout(() => { 
                localStorage.removeItem('user'); 
                // Don't clear prankPlayed so they don't get pranked again on logout
                location.reload(); 
            }, 3000); 
        }

        window.changeMyPassword = async function() {
            const newP = document.getElementById('newPass').value;
            if(!newP) return;
            const docRef = doc(db, "settings", "admins");
            const snap = await getDoc(docRef);
            let list = snap.data().list;
            const idx = list.findIndex(a => a.u === currentUser.u);
            if(idx !== -1) {
                list[idx].p = newP; await setDoc(docRef, { list: list });
                currentUser.p = newP; localStorage.setItem('user', JSON.stringify(currentUser));
                alert("Password Updated!");
            }
        }

        window.addAdmin = async function() {
            const u = document.getElementById('newAdmin').value;
            const p = document.getElementById('newPassAdmin').value;
            await updateDoc(doc(db, "settings", "admins"), { list: arrayUnion({u, p, role:'admin', img:''}) });
            alert("Added!"); loadTeamList();
        }
        
        async function loadTeamList() {
            const snap = await getDoc(doc(db, "settings", "admins"));
            const list = snap.data().list || [];
            document.getElementById('teamList').innerHTML = list.map(a => `<tr><td><b>${a.u}</b></td><td style="color:#e74c3c;">${a.p}</td><td>${a.role}</td></tr>`).join('');
        }

        const fileInput = document.getElementById('imgUploadInput');
        window.enableEdit = function() {
            document.getElementById('admin-panel').style.display='none';
            document.body.classList.add('editing');
            document.getElementById('saveBtn').style.display='block';
            document.querySelectorAll('[data-db]').forEach(el => { el.contentEditable="true"; el.classList.add('editable'); });
            document.querySelectorAll('[data-img]').forEach(el => { 
                el.classList.add('editable-img'); el.onclick = (e) => { e.preventDefault(); targetImgElement = el; isProfileUpload = false; fileInput.click(); };
            });
        }
        
        window.triggerProfileUpload = function() { isProfileUpload = true; fileInput.click(); }
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image(); img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas'); const MAX = 600; const scale = MAX / img.width; canvas.width = MAX; canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); const base64String = canvas.toDataURL('image/jpeg', 0.7);
                    if(isProfileUpload) {
                        const docRef = doc(db, "settings", "admins");
                        getDoc(docRef).then(snap => {
                            let list = snap.data().list; const idx = list.findIndex(a => a.u === currentUser.u);
                            if(idx !== -1) { list[idx].img = base64String; setDoc(docRef, { list: list }); currentUser.img = base64String; localStorage.setItem('user', JSON.stringify(currentUser)); document.getElementById('myNavAvatar').src = base64String; document.getElementById('previewPic').src = base64String; alert("Profile Updated!"); }
                        });
                    } else if(targetImgElement) { targetImgElement.src = base64String; }
                }
            }
        });

        window.saveData = async function() {
            let payload = {};
            document.querySelectorAll('[data-db]').forEach(el => payload[el.getAttribute('data-db')] = el.innerHTML);
            document.querySelectorAll('[data-img]').forEach(el => payload[el.getAttribute('data-img')] = el.src);
            payload['grid_html'] = document.getElementById('dynamicGrid').innerHTML;
            await setDoc(doc(db, "site_data", "content"), payload, {merge:true}); alert("Saved!"); location.reload();
        }

        onSnapshot(doc(db, "site_data", "content"), (doc) => {
            if(doc.exists() && !document.body.classList.contains('editing')) {
                const data = doc.data();
                if(data['grid_html']) document.getElementById('dynamicGrid').innerHTML = data['grid_html'];
                document.querySelectorAll('[data-db]').forEach(el => { const key = el.getAttribute('data-db'); if(data[key]) el.innerHTML = data[key]; });
                document.querySelectorAll('[data-img]').forEach(el => { if(data[el.getAttribute('data-img')]) el.src = data[el.getAttribute('data-img')]; });
            }
        });

        if(currentUser) {
            document.getElementById('loggedOutUI').style.display='none'; document.getElementById('loggedInUI').style.display='flex';
            if(currentUser.img) { document.getElementById('myNavAvatar').src = currentUser.img; document.getElementById('previewPic').src = currentUser.img; }
            if(currentUser.role === 'super_admin') { document.getElementById('superTab').style.display='flex'; loadTeamList(); }
            document.getElementById('fabAdd').style.display='flex';
        }

        function playAnimation(line1, line2) { const overlay = document.getElementById('intro-overlay'); document.getElementById('introMsg').innerHTML = `${line1} <br> <span>${line2}</span>`; overlay.classList.remove('active'); void overlay.offsetWidth; overlay.classList.add('active'); setTimeout(() => { overlay.classList.remove('active'); }, 3500); }
        window.closeDashboard = function() { document.getElementById('admin-panel').style.display = 'none'; }
    </script>

    <script>
        function toggleTheme() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light'); }
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        function route(p) { document.querySelectorAll('.page-sec').forEach(s => s.style.display='none'); if(p === 'home') document.getElementById('home').style.display='block'; else document.getElementById('other-pages').style.display='block'; document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active-page')); event.target.classList.add('active-page'); }
        function openLogin() { document.getElementById('login-modal').style.display='flex'; }
        function openDashboard() { document.getElementById('admin-panel').style.display='flex'; }
        function switchTab(t) { document.querySelectorAll('.dash-section').forEach(s => s.classList.remove('active-sec')); document.getElementById('tab-'+t).classList.add('active-sec'); }
        function toggleSidebar() { document.getElementById('sidebarMenu').classList.toggle('open'); document.querySelector('.overlay-bg').style.display = document.getElementById('sidebarMenu').classList.contains('open') ? 'block' : 'none'; }
    </script>
</body>
</html>
